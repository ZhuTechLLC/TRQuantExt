# 热度评分系统架构文档

## 📍 在主线识别流程中的位置

```
┌──────────────────────────────────────────────────────────────────────┐
│                    主线识别完整流程                                   │
├──────────────────────────────────────────────────────────────────────┤
│  1. 主线识别 → 2. 热度评分 → 3. 个股筛选 → 4. 回测验证 → 5. 实盘监控   │
│        ↓            ↓           ↓                                     │
│    识别潜在      量化关注度    精选标的      验证有效性   风险控制       │
│    投资主线      判断持续性    组合构建      参数优化     实时预警       │
└──────────────────────────────────────────────────────────────────────┘
```

## 🎯 热度评分的意义

### 核心功能
1. **量化市场关注度** - 通过多维度因子评估主线的市场热度
2. **辅助判断持续性** - 热度高的主线通常更具持续性
3. **识别轮动信号** - 热度变化反映资金轮动方向
4. **风险提示** - 过热可能预示短期风险

### 与主线识别的关系
热度评分是主线综合评分的重要组成部分：

```
综合评分 = 热度(30%) + 资金(25%) + 趋势(25%) + 政策(20%)
```

---

## 📊 5因子评分模型

| 因子 | 权重 | 数据来源 | 计算方法 | 解读 |
|------|------|----------|----------|------|
| 涨跌幅强度 | 25% | 同花顺API | 涨跌幅排名百分位×100 | 涨幅越高，关注度越高 |
| 资金流入强度 | 25% | 同花顺API | 净流入排名百分位×100 | 资金流入多，机构认可度高 |
| 涨停板数量 | 20% | 东方财富API | 板块涨停数占比×100 | 涨停多，炒作热度高 |
| 龙虎榜活跃度 | 15% | 东方财富API | 板块龙虎榜占比×100 | 龙虎榜多，游资参与度高 |
| 龙头股强度 | 15% | 同花顺API | 领涨股涨幅排名百分位×100 | 龙头强，带动效应强 |

### 计算公式

```
热度得分 = 涨跌幅强度×25% + 资金流入×25% + 涨停数×20% + 龙虎榜×15% + 龙头强度×15%
```

---

## 📡 数据源API

### 行业板块资金流向
- **接口**: `ak.stock_fund_flow_industry(symbol="即时")`
- **来源**: 同花顺
- **字段**: 行业名称、涨跌幅、净流入、流入资金、领涨股等
- **更新频率**: 实时（交易时间）

### 概念板块资金流向
- **接口**: `ak.stock_fund_flow_concept(symbol="即时")`
- **来源**: 同花顺
- **字段**: 概念名称、涨跌幅、净流入、流入资金、领涨股等
- **更新频率**: 实时（交易时间）

### 涨停池
- **接口**: `ak.stock_zt_pool_em(date="YYYYMMDD")`
- **来源**: 东方财富
- **字段**: 股票代码、名称、涨停封单额、连板数等
- **更新频率**: 实时（交易时间）

### 龙虎榜
- **接口**: `ak.stock_lhb_detail_em(start_date, end_date)`
- **来源**: 东方财富
- **字段**: 股票代码、名称、买入额、卖出额、净买入额等
- **更新频率**: 每日收盘后

---

## 🔢 评分等级

| 等级 | 分数范围 | 颜色 | 含义 | 操作建议 |
|------|----------|------|------|----------|
| 🔥 极热 | ≥80分 | #ef4444 | 市场焦点 | 注意过热风险，适合短线 |
| 📈 高热 | 60-80分 | #f97316 | 热度较高 | 积极跟踪，择机参与 |
| ➡️ 中等 | 40-60分 | #eab308 | 热度一般 | 保持观察，等待催化 |
| ❄️ 偏冷 | 20-40分 | #22c55e | 关注度低 | 可能存在预期差，适合左侧布局 |
| 💤 冷门 | <20分 | #6b7280 | 无人问津 | 暂不参与 |

---

## 🔄 与其他模块的数据流

```
                    ┌─────────────────┐
                    │   RealDataFetcher│
                    │   (数据获取层)    │
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           ↓                 ↓                 ↓
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ 行业板块数据  │ │ 概念板块数据  │ │ 涨停/龙虎榜  │
    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
           │                 │                 │
           └─────────────────┼─────────────────┘
                             ↓
                    ┌─────────────────┐
                    │IntegratedHeatmap│
                    │    Engine       │
                    │ (热度计算引擎)   │
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           ↓                 ↓                 ↓
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │  HeatmapPanel │ │ProMainlinePanel│ │ReportGenerator│
    │  (热度面板)   │ │ (主线识别面板)  │ │ (报告生成)   │
    └──────────────┘ └──────────────┘ └──────────────┘
```

---

## 📁 相关文件

```
markets/ashare/mainline/
├── integrated_heatmap.py      # 集成热度评分引擎
├── real_data_fetcher.py       # 数据获取层
├── heatmap_report_generator.py # 报告生成器
├── pro_engine.py              # 专业主线识别引擎

gui/widgets/
├── heatmap_panel.py           # 热度评分面板
├── pro_mainline_panel.py      # 专业主线识别面板

docs/
├── HEATMAP_SYSTEM_ARCHITECTURE.md  # 本文档
└── HEATMAP_FIX_PHASE1.md           # 阶段1修复记录
```

---

## 🛠 技术细节

### 数据估算逻辑

由于涨停池和龙虎榜API无法直接提供每个板块的关联统计，系统采用智能估算：

1. **涨停数估算**
   - 优先使用名称匹配的直接数据
   - 若无匹配，使用涨幅(60%)+资金(40%)排名加权估算
   - 涨幅>5%额外加成20%，>3%加成10%

2. **龙虎榜估算**
   - 优先使用名称匹配的直接数据
   - 若无匹配，使用涨幅(40%)+龙头涨幅(60%)排名加权估算
   - 龙头涨停(≥9.5%)额外加成30%

### 排名百分位计算

```python
def _calculate_percentile(value, all_values):
    count_less = sum(1 for v in all_values if v < value)
    return (count_less / len(all_values)) * 100
```

---

## ✅ 测试验证

```
=== 热度分布示例 ===
极热(≥80): 6条
高热(60-80): 19条
中等(40-60): 29条
偏冷(<40): 26条
```

---

## 📝 更新日志

### 2024-11-28
- 创建集成热度评分引擎 (`integrated_heatmap.py`)
- 重构热度评分面板 (`heatmap_panel.py`)
- 优化涨停/龙虎榜关联逻辑
- 修复归一化和趋势显示问题

---

*韬睿量化 - 热度评分系统*

