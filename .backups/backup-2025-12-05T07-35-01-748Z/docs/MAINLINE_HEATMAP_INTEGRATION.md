# 主线识别与热度评分的衔接关系

## 📊 两个模块的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据流与衔接关系                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌──────────────┐     共享数据源      ┌──────────────┐                    │
│    │   主线识别    │ ←───────────────→ │   热度评分    │                    │
│    │  (5维度评分)  │                    │  (5因子评分)  │                    │
│    └──────┬───────┘                    └──────┬───────┘                    │
│           │                                    │                            │
│           │ 热度维度(20%)                      │ 输出热度得分               │
│           │ ←──────────────────────────────────┘                            │
│           │                                                                 │
│           ↓                                                                 │
│    ┌──────────────┐                                                         │
│    │   综合评分    │                                                         │
│    │ =热度30%+资金25%+趋势25%+政策20%                                        │
│    └──────┬───────┘                                                         │
│           │                                                                 │
│           ↓                                                                 │
│    ┌──────────────┐                                                         │
│    │   个股筛选    │ ← 读取 latest_heatmap_scores.json                       │
│    │  (选股策略)   │   筛选高热度主线内的个股                                  │
│    └──────────────┘                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 主线识别 vs 热度评分

| 维度 | 主线识别 (5维度) | 热度评分 (5因子) | 衔接关系 |
|------|-----------------|-----------------|---------|
| **资金** | 资金维度 25% | 资金流入强度 25% | 共享数据源 |
| **动量** | 动量维度 20% | 涨跌幅强度 25% | 共享数据源 |
| **热度** | 热度维度 20% | **本模块输出** | 热度评分→主线识别 |
| **政策** | 政策维度 20% | (需LLM分析) | 独立计算 |
| **龙头** | 龙头维度 15% | 龙头股强度 15% | 共享数据源 |

---

## 📡 共享的数据源

```
同花顺 API:
├── stock_fund_flow_industry  → 行业板块资金流向
│   ├── 用于：资金维度、动量维度
│   └── 字段：涨跌幅、净流入、领涨股
│
└── stock_fund_flow_concept   → 概念板块资金流向
    ├── 用于：资金维度、动量维度
    └── 字段：涨跌幅、净流入、领涨股

东方财富 API:
├── stock_zt_pool_em         → 涨停池
│   ├── 用于：热度维度
│   └── 字段：涨停数量、连板数
│
└── stock_lhb_detail_em      → 龙虎榜
    ├── 用于：热度维度
    └── 字段：上榜股票、买卖额
```

---

## 🔢 热度评分5因子模型

| 因子 | 权重 | 数据来源 | 计算方法 | 传递到主线识别 |
|------|------|----------|----------|---------------|
| 涨跌幅强度 | 25% | 同花顺 | 排名百分位×100 | → 动量维度 |
| 资金流入强度 | 25% | 同花顺 | 排名百分位×100 | → 资金维度 |
| 涨停板数量 | 20% | 东方财富 | 占比×100 | → 热度维度 |
| 龙虎榜活跃度 | 15% | 东方财富 | 占比×100 | → 热度维度 |
| 龙头股强度 | 15% | 同花顺 | 排名百分位×100 | → 龙头维度 |

---

## 📂 数据传递机制

### 热度评分输出
```python
# 保存路径
~/.local/share/jqquant/reports/heatmap/latest_heatmap_scores.json

# 数据格式
{
    "timestamp": "2024-11-28T15:30:00",
    "scores": [
        {
            "name": "军工电子",
            "type": "industry",
            "total_score": 89.3,
            "change_score": 93,
            "flow_score": 80,
            "limit_up_score": 88,
            "lhb_score": 100,
            "leader_score": 83,
            "level": "极热"
        },
        ...
    ],
    "high_heat_mainlines": ["军工电子", "商业航天", ...]
}
```

### 个股筛选读取
```python
# 读取热度评分
with open("latest_heatmap_scores.json") as f:
    heatmap_data = json.load(f)

# 筛选高热度主线
high_heat = heatmap_data["high_heat_mainlines"]

# 在这些主线内筛选个股
for mainline in high_heat:
    stocks = get_stocks_in_mainline(mainline)
    for stock in stocks:
        # 个股评分 = 所属主线热度×15% + 个股因子×85%
        stock_score = mainline_heat * 0.15 + stock_factors * 0.85
```

---

## 📊 综合评分公式

主线识别模块最终使用以下综合评分公式：

```
综合评分 = 热度维度×30% + 资金维度×25% + 趋势维度×25% + 政策维度×20%

其中:
- 热度维度 = 热度评分模块的总分
- 资金维度 = 资金流入强度得分
- 趋势维度 = 涨跌幅+动量得分
- 政策维度 = LLM分析得分（待实现）
```

---

## 🔄 更新时间

- 热度评分：每次点击计算时更新
- 主线识别：每次点击分析时更新
- 个股筛选：读取最新的热度评分结果

---

*韬睿量化 - 主线识别与热度评分集成架构*

