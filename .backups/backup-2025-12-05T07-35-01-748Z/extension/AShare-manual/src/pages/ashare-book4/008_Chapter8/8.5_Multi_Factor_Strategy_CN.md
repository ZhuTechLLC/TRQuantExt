---
title: "8.5 å¤šå› å­ç­–ç•¥å®ç°"
description: "å°†å¤šå› å­æ¨¡å‹è½¬åŒ–ä¸ºPTradeç­–ç•¥ä»£ç çš„å®Œæ•´å®ç°"
lang: "zh-CN"
layout: "/src/layouts/Layout.astro"
currentBook: "ashare-quantitative"
currentChapter: "ashare-quantitative-chapter8"
updateDate: "2025-01-26"
---

# ğŸ”— 8.5 å¤šå› å­ç­–ç•¥å®ç°

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚å°†ç¬¬ä¸ƒç« çš„å¤šå› å­æ¨¡å‹è½¬åŒ–ä¸ºPTradeå¯æ‰§è¡Œçš„ç­–ç•¥ä»£ç ã€‚é€šè¿‡å®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨PTradeä¸­å®ç°å› å­è®¡ç®—ã€å› å­åˆæˆã€é€‰è‚¡å’Œè°ƒä»“çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<div class="section-overview">
  <div class="overview-item">
    <span class="item-icon">ğŸ“Š</span>
    <a href="#factor">å› å­è®¡ç®—</a>
    <span class="item-desc">PTradeä¸­çš„å› å­è®¡ç®—å®ç°</span>
  </div>
  <div class="overview-item">
    <span class="item-icon">ğŸ”—</span>
    <a href="#combine">å› å­åˆæˆ</a>
    <span class="item-desc">å¤šå› å­å¾—åˆ†åˆæˆ</span>
  </div>
  <div class="overview-item">
    <span class="item-icon">ğŸ“ˆ</span>
    <a href="#select">é€‰è‚¡é€»è¾‘</a>
    <span class="item-desc">åŸºäºå› å­å¾—åˆ†çš„é€‰è‚¡</span>
  </div>
  <div class="overview-item">
    <span class="item-icon">ğŸ’¹</span>
    <a href="#complete">å®Œæ•´ç­–ç•¥</a>
    <span class="item-desc">å¯è¿è¡Œçš„å®Œæ•´ç­–ç•¥ä»£ç </span>
  </div>
</div>

---

<h2 id="factor">ğŸ“Š å› å­è®¡ç®—</h2>

### PTradeå› å­è®¡ç®—æ¨¡å—

<div class="board-details">
  <div class="board-card">
    <h4>ğŸ“Š å› å­è®¡ç®—å‡½æ•°</h4>
    <div class="board-content">

```python
import pandas as pd
import numpy as np

def calc_ep_factor(stocks, date):
    """
    è®¡ç®—EPå› å­ï¼ˆå¸‚ç›ˆç‡å€’æ•°ï¼‰
    EP = 1 / PE_TTM
    """
    df = get_fundamentals(query(
        valuation.code,
        valuation.pe_ratio
    ).filter(
        valuation.code.in_(stocks),
        valuation.pe_ratio > 0  # æ’é™¤è´ŸPE
    ), date=date)
    
    df['ep'] = 1 / df['pe_ratio']
    return df[['code', 'ep']]

def calc_roe_factor(stocks, date):
    """
    è®¡ç®—ROEå› å­
    """
    df = get_fundamentals(query(
        valuation.code,
        indicator.roe
    ).filter(
        valuation.code.in_(stocks)
    ), date=date)
    
    return df[['code', 'roe']]

def calc_momentum_factor(stocks, date, window=20):
    """
    è®¡ç®—åŠ¨é‡å› å­ï¼ˆ20æ—¥æ”¶ç›Šç‡ï¼‰
    """
    # è·å–å†å²ä»·æ ¼
    prices = get_price(
        stocks,
        end_date=date,
        count=window + 1,
        fields=['close']
    )
    
    # è®¡ç®—æ”¶ç›Šç‡
    momentum = prices['close'].iloc[-1] / prices['close'].iloc[0] - 1
    
    df = pd.DataFrame({
        'code': momentum.index,
        'momentum': momentum.values
    })
    
    return df

def calc_growth_factor(stocks, date):
    """
    è®¡ç®—æˆé•¿å› å­ï¼ˆè¥æ”¶å¢é€Ÿï¼‰
    """
    df = get_fundamentals(query(
        valuation.code,
        indicator.inc_revenue_year_on_year
    ).filter(
        valuation.code.in_(stocks)
    ), date=date)
    
    df.columns = ['code', 'growth']
    return df

def calc_quality_factor(stocks, date):
    """
    è®¡ç®—è´¨é‡å› å­ï¼ˆæ¯›åˆ©ç‡ï¼‰
    """
    df = get_fundamentals(query(
        valuation.code,
        indicator.gross_profit_margin
    ).filter(
        valuation.code.in_(stocks)
    ), date=date)
    
    df.columns = ['code', 'quality']
    return df
```

</div>
  </div>
</div>

---

<h2 id="combine">ğŸ”— å› å­åˆæˆ</h2>

### å› å­é¢„å¤„ç†ä¸åˆæˆ

<div class="board-details">
  <div class="board-card">
    <h4>ğŸ”— å› å­åˆæˆå‡½æ•°</h4>
    <div class="board-content">

```python
def preprocess_factor(df, factor_name):
    """
    å› å­é¢„å¤„ç†ï¼šå»æå€¼ã€æ ‡å‡†åŒ–
    """
    # å»æå€¼ï¼ˆMADæ–¹æ³•ï¼‰
    median = df[factor_name].median()
    mad = (df[factor_name] - median).abs().median()
    df[factor_name] = df[factor_name].clip(
        median - 3 * 1.4826 * mad,
        median + 3 * 1.4826 * mad
    )
    
    # Z-Scoreæ ‡å‡†åŒ–
    mean = df[factor_name].mean()
    std = df[factor_name].std()
    if std > 0:
        df[factor_name + '_zscore'] = (df[factor_name] - mean) / std
    else:
        df[factor_name + '_zscore'] = 0
    
    return df

def combine_factors(factor_dfs, weights):
    """
    å¤šå› å­åˆæˆ
    
    å‚æ•°:
        factor_dfs: å› å­DataFrameåˆ—è¡¨
        weights: å› å­æƒé‡åˆ—è¡¨
    
    è¿”å›:
        åˆæˆåçš„å› å­å¾—åˆ†DataFrame
    """
    # åˆå¹¶æ‰€æœ‰å› å­
    combined = factor_dfs[0][['code']].copy()
    
    for i, df in enumerate(factor_dfs):
        factor_name = df.columns[1]
        df = preprocess_factor(df.copy(), factor_name)
        combined = combined.merge(
            df[['code', factor_name + '_zscore']], 
            on='code', 
            how='outer'
        )
    
    # è®¡ç®—ç»¼åˆå¾—åˆ†
    zscore_cols = [col for col in combined.columns if col.endswith('_zscore')]
    combined['total_score'] = 0
    for i, col in enumerate(zscore_cols):
        combined['total_score'] += combined[col].fillna(0) * weights[i]
    
    return combined[['code', 'total_score']]
```

</div>
  </div>
</div>

---

<h2 id="select">ğŸ“ˆ é€‰è‚¡é€»è¾‘</h2>

### åŸºäºå› å­å¾—åˆ†çš„é€‰è‚¡

<div class="board-details">
  <div class="board-card">
    <h4>ğŸ“ˆ é€‰è‚¡å‡½æ•°</h4>
    <div class="board-content">

```python
def select_stocks(score_df, n=30, exclude_st=True, exclude_suspend=True):
    """
    åŸºäºå› å­å¾—åˆ†é€‰è‚¡
    
    å‚æ•°:
        score_df: å› å­å¾—åˆ†DataFrame
        n: é€‰è‚¡æ•°é‡
        exclude_st: æ˜¯å¦æ’é™¤STè‚¡ç¥¨
        exclude_suspend: æ˜¯å¦æ’é™¤åœç‰Œè‚¡ç¥¨
    
    è¿”å›:
        é€‰ä¸­çš„è‚¡ç¥¨åˆ—è¡¨
    """
    # æ’é™¤STè‚¡ç¥¨
    if exclude_st:
        st_stocks = get_extras('is_st', score_df['code'].tolist(), 
                               end_date=context.current_dt)
        st_stocks = st_stocks.iloc[-1]
        non_st = st_stocks[st_stocks == False].index.tolist()
        score_df = score_df[score_df['code'].isin(non_st)]
    
    # æ’é™¤åœç‰Œè‚¡ç¥¨
    if exclude_suspend:
        suspended = get_price(
            score_df['code'].tolist(),
            end_date=context.current_dt,
            count=1,
            fields=['paused']
        )['paused'].iloc[-1]
        active = suspended[suspended == False].index.tolist()
        score_df = score_df[score_df['code'].isin(active)]
    
    # é€‰æ‹©å¾—åˆ†æœ€é«˜çš„Nåªè‚¡ç¥¨
    top_stocks = score_df.nlargest(n, 'total_score')
    
    return top_stocks['code'].tolist()
```

</div>
  </div>
</div>

---

<h2 id="complete">ğŸ’¹ å®Œæ•´ç­–ç•¥</h2>

### PTradeå¤šå› å­ç­–ç•¥å®Œæ•´ä»£ç 

<div class="board-details">
  <div class="board-card">
    <h4>ğŸ’¹ å®Œæ•´ç­–ç•¥ä»£ç </h4>
    <div class="board-content">

```python
"""
PTradeå¤šå› å­é€‰è‚¡ç­–ç•¥
åŸºäºä»·å€¼ã€æˆé•¿ã€è´¨é‡ã€åŠ¨é‡å››å› å­
ä¸éŸ¬ç¿é‡åŒ–ç³»ç»Ÿæ·±åº¦é›†æˆ
"""

import pandas as pd
import numpy as np

# ============ ç­–ç•¥å‚æ•° ============
FACTORS = ['ep', 'growth', 'quality', 'momentum']
WEIGHTS = [0.3, 0.25, 0.25, 0.2]  # å› å­æƒé‡
HOLD_NUM = 30  # æŒä»“æ•°é‡
REBALANCE_DAY = 1  # æ¯æœˆç¬¬å‡ ä¸ªäº¤æ˜“æ—¥è°ƒä»“

# ============ åˆå§‹åŒ– ============
def initialize(context):
    """ç­–ç•¥åˆå§‹åŒ–"""
    # è‚¡ç¥¨æ± ï¼šæ²ªæ·±300æˆåˆ†è‚¡
    context.stock_pool = get_index_stocks('000300.SH')
    
    # åŸºå‡†
    set_benchmark('000300.SH')
    
    # äº¤æ˜“æˆæœ¬
    set_slippage(FixedSlippage(0.002))
    set_commission(PerOrder(buy_cost=0.0003, sell_cost=0.0013))
    
    # ç­–ç•¥å‚æ•°
    context.hold_num = HOLD_NUM
    context.rebalance_day = REBALANCE_DAY
    context.target_stocks = []
    
    log.info('ç­–ç•¥åˆå§‹åŒ–å®Œæˆ')

# ============ æ¯æ—¥å¼€ç›˜å‰ ============
def before_trading_start(context, data):
    """æ¯æ—¥å¼€ç›˜å‰æ‰§è¡Œ"""
    # åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒä»“æ—¥
    if is_rebalance_day(context):
        log.info('ä»Šæ—¥ä¸ºè°ƒä»“æ—¥ï¼Œå¼€å§‹è®¡ç®—å› å­...')
        
        # è®¡ç®—å„å› å­
        ep_df = calc_ep_factor(context.stock_pool, context.current_dt)
        growth_df = calc_growth_factor(context.stock_pool, context.current_dt)
        quality_df = calc_quality_factor(context.stock_pool, context.current_dt)
        momentum_df = calc_momentum_factor(context.stock_pool, context.current_dt)
        
        # å› å­åˆæˆ
        factor_dfs = [ep_df, growth_df, quality_df, momentum_df]
        score_df = combine_factors(factor_dfs, WEIGHTS)
        
        # é€‰è‚¡
        context.target_stocks = select_stocks(score_df, context.hold_num)
        
        log.info(f'é€‰å‡º{len(context.target_stocks)}åªè‚¡ç¥¨')

def is_rebalance_day(context):
    """åˆ¤æ–­æ˜¯å¦ä¸ºè°ƒä»“æ—¥"""
    # è·å–æœ¬æœˆäº¤æ˜“æ—¥
    month_start = context.current_dt.replace(day=1)
    trading_days = get_trade_days(
        start_date=month_start, 
        end_date=context.current_dt
    )
    
    # åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬æœˆç¬¬Nä¸ªäº¤æ˜“æ—¥
    if len(trading_days) >= context.rebalance_day:
        if trading_days[context.rebalance_day - 1] == context.current_dt.date():
            return True
    return False

# ============ äº¤æ˜“é€»è¾‘ ============
def handle_data(context, data):
    """æ¯ä¸ªäº¤æ˜“å‘¨æœŸæ‰§è¡Œ"""
    if is_rebalance_day(context) and len(context.target_stocks) > 0:
        rebalance(context, context.target_stocks)

def rebalance(context, target_stocks):
    """è°ƒä»“å‡½æ•°"""
    log.info('å¼€å§‹è°ƒä»“...')
    
    # è·å–å½“å‰æŒä»“
    current_positions = list(context.portfolio.positions.keys())
    
    # å–å‡ºä¸åœ¨ç›®æ ‡æ± çš„è‚¡ç¥¨
    for stock in current_positions:
        if stock not in target_stocks:
            order_target(stock, 0)
            log.info(f'å–å‡º: {stock}')
    
    # è®¡ç®—ç›®æ ‡æƒé‡
    weight = 1.0 / len(target_stocks)
    
    # ä¹°å…¥ç›®æ ‡è‚¡ç¥¨
    for stock in target_stocks:
        order_target_percent(stock, weight)
        log.info(f'ä¹°å…¥: {stock}, ç›®æ ‡æƒé‡: {weight:.2%}')
    
    log.info('è°ƒä»“å®Œæˆ')

# ============ å› å­è®¡ç®—å‡½æ•°ï¼ˆåŒä¸Šï¼‰============
# ... (ä½¿ç”¨å‰é¢å®šä¹‰çš„å› å­è®¡ç®—å‡½æ•°)

# ============ å› å­åˆæˆå‡½æ•°ï¼ˆåŒä¸Šï¼‰============
# ... (ä½¿ç”¨å‰é¢å®šä¹‰çš„å› å­åˆæˆå‡½æ•°)

# ============ é€‰è‚¡å‡½æ•°ï¼ˆåŒä¸Šï¼‰============
# ... (ä½¿ç”¨å‰é¢å®šä¹‰çš„é€‰è‚¡å‡½æ•°)
```

</div>
  </div>
</div>

### ç­–ç•¥å‚æ•°è¯´æ˜

<div class="comparison-table">
  <table>
    <thead>
      <tr>
        <th>å‚æ•°</th>
        <th>é»˜è®¤å€¼</th>
        <th>è¯´æ˜</th>
        <th>è°ƒæ•´å»ºè®®</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>FACTORS</strong></td>
        <td>4ä¸ªå› å­</td>
        <td>ä½¿ç”¨çš„å› å­åˆ—è¡¨</td>
        <td>å¯å¢å‡å› å­</td>
      </tr>
      <tr>
        <td><strong>WEIGHTS</strong></td>
        <td>0.3/0.25/0.25/0.2</td>
        <td>å› å­æƒé‡</td>
        <td>æ ¹æ®ICè°ƒæ•´</td>
      </tr>
      <tr>
        <td><strong>HOLD_NUM</strong></td>
        <td>30</td>
        <td>æŒä»“è‚¡ç¥¨æ•°é‡</td>
        <td>20-50</td>
      </tr>
      <tr>
        <td><strong>REBALANCE_DAY</strong></td>
        <td>1</td>
        <td>æ¯æœˆè°ƒä»“æ—¥</td>
        <td>1-5</td>
      </tr>
    </tbody>
  </table>
</div>

## ğŸ’ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

<div class="key-points">
  <div class="key-point">
    <h4>ğŸ“Š æ¨¡å—åŒ–è®¾è®¡</h4>
    <p>å› å­è®¡ç®—ã€é¢„å¤„ç†ã€åˆæˆã€é€‰è‚¡å„æ¨¡å—ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•</p>
  </div>
  <div class="key-point">
    <h4>ğŸ”— å› å­å¯é…ç½®</h4>
    <p>å› å­åˆ—è¡¨å’Œæƒé‡å¯é€šè¿‡å‚æ•°é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç </p>
  </div>
  <div class="key-point">
    <h4>âš¡ é£é™©æ§åˆ¶</h4>
    <p>å†…ç½®STè‚¡ç¥¨å’Œåœç‰Œè‚¡ç¥¨è¿‡æ»¤ï¼Œé™ä½é£é™©</p>
  </div>
  <div class="key-point">
    <h4>ğŸ“ æ—¥å¿—å®Œå–„</h4>
    <p>å…³é”®æ­¥éª¤è¾“å‡ºæ—¥å¿—ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•</p>
  </div>
</div>

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚å±•ç¤ºäº†å¦‚ä½•åœ¨PTradeä¸­å®ç°å®Œæ•´çš„å¤šå› å­ç­–ç•¥ï¼ŒåŒ…æ‹¬å› å­è®¡ç®—ã€å› å­é¢„å¤„ç†ã€å› å­åˆæˆã€é€‰è‚¡å’Œè°ƒä»“çš„å®Œæ•´ä»£ç ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>ä¸‹ä¸€èŠ‚å°†å­¦ä¹ PTradeç­–ç•¥çš„å®ç›˜éƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿäº¤æ˜“ã€å®ç›˜é…ç½®å’Œç›‘æ§ç®¡ç†ã€‚</p>
  
  <a href="/ashare-book4/008_Chapter8/8.6_Live_Deployment_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š8.6 å®ç›˜éƒ¨ç½² â†’
  </a>
</div>
