---
/**
 * Finnhubç»¼åˆæŠ•èµ„ä»ªè¡¨æ¿
 * åŸºäºPDFæ–‡æ¡£çš„å®Œæ•´åŠŸèƒ½å®ç°
 * æ”¯æŒæ–°é—»é˜…è¯»ã€æ•°æ®ä¿å­˜ã€æƒ…æ„Ÿåˆ†æç­‰
 */
import Layout from '../layouts/Layout.astro';

// Finnhub APIé…ç½®
const FINNHUB_API_KEY = 'd40eokhr01qqo3qhl4h0d40eokhr01qqo3qhl4hg';
---

<Layout title="FinnhubæŠ•èµ„ä»ªè¡¨æ¿">
  <style>
    /* å…¨å±€æ ·å¼ */
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
      --warning-gradient: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
      --danger-gradient: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-gradient: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2d3748;
    }

    /* ä¸»å®¹å™¨ */
    .dashboard-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }

    /* é¡µé¢å¤´éƒ¨ */
    .page-header {
      background: white;
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      text-align: center;
    }

    .page-header h1 {
      font-size: 3.5em;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
    }

    .page-subtitle {
      font-size: 1.3em;
      color: #718096;
      margin-bottom: 25px;
    }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }

    .control-btn {
      padding: 15px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .control-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-success {
      background: var(--success-gradient);
      color: white;
    }

    .btn-warning {
      background: var(--warning-gradient);
      color: white;
    }

    .btn-info {
      background: var(--info-gradient);
      color: white;
    }

    .btn-dark {
      background: var(--dark-gradient);
      color: white;
    }

    /* ä»ªè¡¨æ¿ç½‘æ ¼ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .dashboard-panel {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .dashboard-panel:hover {
      transform: translateY(-5px);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e2e8f0;
    }

    .panel-icon {
      font-size: 2.5em;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      background: var(--primary-gradient);
    }

    .panel-title {
      font-size: 1.8em;
      font-weight: 700;
      color: #2d3748;
    }

    .panel-subtitle {
      font-size: 1em;
      color: #718096;
      margin-top: 5px;
    }

    /* æ–°é—»é˜…è¯»å™¨ */
    .news-reader {
      max-height: 600px;
      overflow-y: auto;
    }

    .news-item {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .news-item:hover {
      background: #e6f3ff;
      transform: translateX(5px);
    }

    .news-item.saved {
      border-left-color: #0ba360;
      background: #f0f9f4;
    }

    .news-item.important {
      border-left-color: #f2994a;
      background: #fff8f0;
    }

    .news-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .news-source {
      font-weight: 600;
      color: #667eea;
      font-size: 0.9em;
    }

    .news-time {
      font-size: 0.85em;
      color: #a0aec0;
    }

    .news-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .news-summary {
      font-size: 0.95em;
      color: #718096;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .news-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-save {
      background: #e6f3ff;
      color: #0066cc;
    }

    .btn-save:hover {
      background: #0066cc;
      color: white;
    }

    .btn-save.saved {
      background: #0ba360;
      color: white;
    }

    .btn-analyze {
      background: #f0f4ff;
      color: #667eea;
    }

    .btn-analyze:hover {
      background: #667eea;
      color: white;
    }

    .btn-share {
      background: #fff0e6;
      color: #f2994a;
    }

    .btn-share:hover {
      background: #f2994a;
      color: white;
    }

    /* æƒ…æ„Ÿåˆ†æé¢æ¿ */
    .sentiment-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .sentiment-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }

    .sentiment-card.positive {
      border-color: #0ba360;
      background: #f0f9f4;
    }

    .sentiment-card.negative {
      border-color: #eb3349;
      background: #fef2f2;
    }

    .sentiment-card.neutral {
      border-color: #a0aec0;
      background: #f7fafc;
    }

    .sentiment-score {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .sentiment-label {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .sentiment-description {
      font-size: 0.9em;
      color: #718096;
    }

    /* æ•°æ®ä¿å­˜é¢æ¿ */
    .data-storage {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .storage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      color: #718096;
    }

    .export-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-export-json {
      background: #e6f3ff;
      color: #0066cc;
    }

    .btn-export-csv {
      background: #f0f9f4;
      color: #0ba360;
    }

    .btn-export-pdf {
      background: #fef2f2;
      color: #eb3349;
    }

    /* å®æ—¶æ•°æ®æµ */
    .realtime-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: #f0f9f4;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #0ba360;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .status-dot.disconnected {
      background: #eb3349;
      animation: none;
    }

    /* æœç´¢å’Œç­›é€‰ */
    .search-panel {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .search-controls {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 15px;
      align-items: end;
    }

    .search-input {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .filter-select {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1em;
      background: white;
    }

    .search-btn {
      padding: 12px 25px;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f4f6;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .control-panel {
        grid-template-columns: 1fr;
      }

      .search-controls {
        grid-template-columns: 1fr;
      }

      .sentiment-panel {
        grid-template-columns: 1fr;
      }

      .storage-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <div class="dashboard-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="page-header">
      <h1>ğŸ“Š FinnhubæŠ•èµ„ä»ªè¡¨æ¿</h1>
      <p class="page-subtitle">åŸºäºFinnhub APIçš„å…¨é¢æŠ•èµ„åˆ†æå¹³å° Â· å®æ—¶æ•°æ® Â· æ™ºèƒ½åˆ†æ Â· æ•°æ®ä¿å­˜</p>
      
      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="control-panel">
        <button class="control-btn btn-primary" id="btnRefresh">
          <span>ğŸ”„</span>
          <span>åˆ·æ–°æ•°æ®</span>
        </button>
        <button class="control-btn btn-success" id="btnSaveAll">
          <span>ğŸ’¾</span>
          <span>ä¿å­˜æ‰€æœ‰</span>
        </button>
        <button class="control-btn btn-warning" id="btnAnalyze">
          <span>ğŸ§ </span>
          <span>æ™ºèƒ½åˆ†æ</span>
        </button>
        <button class="control-btn btn-info" id="btnExport">
          <span>ğŸ“¤</span>
          <span>å¯¼å‡ºæ•°æ®</span>
        </button>
        <button class="control-btn btn-dark" id="btnSettings">
          <span>âš™ï¸</span>
          <span>è®¾ç½®</span>
        </button>
      </div>
    </header>

    <!-- æœç´¢å’Œç­›é€‰é¢æ¿ -->
    <div class="search-panel">
      <h3 style="margin-bottom: 20px; color: #2d3748;">ğŸ” æœç´¢å’Œç­›é€‰</h3>
      <div class="search-controls">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ–°é—»æ ‡é¢˜ã€å†…å®¹æˆ–å…³é”®è¯...">
        <select class="filter-select" id="sourceFilter">
          <option value="all">æ‰€æœ‰åª’ä½“æº</option>
          <option value="MarketWatch">MarketWatch</option>
          <option value="CNBC">CNBC</option>
        </select>
        <select class="filter-select" id="categoryFilter">
          <option value="general">ç»¼åˆ</option>
          <option value="forex">å¤–æ±‡</option>
          <option value="crypto">åŠ å¯†è´§å¸</option>
          <option value="merger">å¹¶è´­</option>
        </select>
        <button class="search-btn" id="searchBtn">æœç´¢</button>
      </div>
    </div>

    <!-- ä»ªè¡¨æ¿ç½‘æ ¼ -->
    <div class="dashboard-grid">
      <!-- æ–°é—»é˜…è¯»å™¨ -->
      <div class="dashboard-panel">
        <div class="panel-header">
          <div class="panel-icon">ğŸ“°</div>
          <div>
            <div class="panel-title">æ–°é—»é˜…è¯»å™¨</div>
            <div class="panel-subtitle">å®æ—¶è´¢ç»æ–°é—» Â· æ™ºèƒ½åˆ†æ Â· ä¸€é”®ä¿å­˜</div>
          </div>
        </div>
        
        <!-- å®æ—¶çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="realtime-indicator">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">è¿æ¥ä¸­...</span>
        </div>

        <!-- æ–°é—»åˆ—è¡¨ -->
        <div class="news-reader" id="newsReader">
          <div class="loading">
            <div class="loading-spinner"></div>
            <h3>æ­£åœ¨åŠ è½½æ–°é—»...</h3>
            <p>è¯·ç¨å€™</p>
          </div>
        </div>
      </div>

      <!-- æƒ…æ„Ÿåˆ†æé¢æ¿ -->
      <div class="dashboard-panel">
        <div class="panel-header">
          <div class="panel-icon">ğŸ§ </div>
          <div>
            <div class="panel-title">æƒ…æ„Ÿåˆ†æ</div>
            <div class="panel-subtitle">å¸‚åœºæƒ…ç»ª Â· æŠ•èµ„ä¿¡å· Â· é£é™©è¯„ä¼°</div>
          </div>
        </div>

        <!-- æƒ…æ„Ÿåˆ†æå¡ç‰‡ -->
        <div class="sentiment-panel" id="sentimentPanel">
          <div class="sentiment-card neutral">
            <div class="sentiment-score">0.0</div>
            <div class="sentiment-label">æ•´ä½“æƒ…ç»ª</div>
            <div class="sentiment-description">ä¸­æ€§</div>
          </div>
          <div class="sentiment-card positive">
            <div class="sentiment-score">0</div>
            <div class="sentiment-label">æ­£é¢æ–°é—»</div>
            <div class="sentiment-description">ç§¯æä¿¡å·</div>
          </div>
          <div class="sentiment-card negative">
            <div class="sentiment-score">0</div>
            <div class="sentiment-label">è´Ÿé¢æ–°é—»</div>
            <div class="sentiment-description">é£é™©æç¤º</div>
          </div>
        </div>

        <!-- æ•°æ®ä¿å­˜ç»Ÿè®¡ -->
        <div class="data-storage">
          <h4 style="margin-bottom: 15px; color: #2d3748;">ğŸ“Š æ•°æ®ä¿å­˜ç»Ÿè®¡</h4>
          <div class="storage-stats">
            <div class="stat-item">
              <div class="stat-number" id="totalSaved">0</div>
              <div class="stat-label">å·²ä¿å­˜æ–°é—»</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="analyzedCount">0</div>
              <div class="stat-label">å·²åˆ†ææ–‡ç« </div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="exportCount">0</div>
              <div class="stat-label">å¯¼å‡ºæ¬¡æ•°</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="lastUpdate">--:--</div>
              <div class="stat-label">æœ€åæ›´æ–°</div>
            </div>
          </div>
          
          <div class="export-actions">
            <button class="export-btn btn-export-json" id="exportJson">å¯¼å‡ºJSON</button>
            <button class="export-btn btn-export-csv" id="exportCsv">å¯¼å‡ºCSV</button>
            <button class="export-btn btn-export-pdf" id="exportPdf">å¯¼å‡ºPDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ FINNHUB_API_KEY }}>
    // å…¨å±€çŠ¶æ€
    let allNewsData = [];
    let filteredNewsData = [];
    let savedNews = JSON.parse(localStorage.getItem('savedNews') || '[]');
    let analyzedNews = JSON.parse(localStorage.getItem('analyzedNews') || '[]');
    let isConnected = false;

    // DOMå…ƒç´ 
    const newsReader = document.getElementById('newsReader');
    const sentimentPanel = document.getElementById('sentimentPanel');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const searchInput = document.getElementById('searchInput');
    const sourceFilter = document.getElementById('sourceFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const searchBtn = document.getElementById('searchBtn');
    const totalSaved = document.getElementById('totalSaved');
    const analyzedCount = document.getElementById('analyzedCount');
    const exportCount = document.getElementById('exportCount');
    const lastUpdate = document.getElementById('lastUpdate');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateStats();
      fetchNews();
      setupEventListeners();
    });

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // æœç´¢åŠŸèƒ½
      searchBtn.addEventListener('click', performSearch);
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
      });

      // ç­›é€‰åŠŸèƒ½
      sourceFilter.addEventListener('change', performSearch);
      categoryFilter.addEventListener('change', function() {
        fetchNews(categoryFilter.value);
      });

      // æ§åˆ¶æŒ‰é’®
      document.getElementById('btnRefresh').addEventListener('click', () => fetchNews());
      document.getElementById('btnSaveAll').addEventListener('click', saveAllNews);
      document.getElementById('btnAnalyze').addEventListener('click', analyzeAllNews);
      document.getElementById('btnExport').addEventListener('click', showExportOptions);
      document.getElementById('btnSettings').addEventListener('click', showSettings);

      // å¯¼å‡ºæŒ‰é’®
      document.getElementById('exportJson').addEventListener('click', () => exportData('json'));
      document.getElementById('exportCsv').addEventListener('click', () => exportData('csv'));
      document.getElementById('exportPdf').addEventListener('click', () => exportData('pdf'));
    }

    // è·å–æ–°é—»æ•°æ®
    async function fetchNews(category = 'general') {
      try {
        showLoading();
        updateConnectionStatus('connecting');
        
        const url = `https://finnhub.io/api/v1/news?category=${category}&token=${FINNHUB_API_KEY}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        allNewsData = data;
        filteredNewsData = data;
        displayNews(data);
        updateConnectionStatus('connected');
        updateStats();
        
      } catch (error) {
        console.error('è·å–æ–°é—»å¤±è´¥:', error);
        updateConnectionStatus('disconnected');
        showError('è·å–æ–°é—»å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    }

    // æ˜¾ç¤ºæ–°é—»
    function displayNews(newsData) {
      if (!newsData || newsData.length === 0) {
        newsReader.innerHTML = '<div class="loading"><h3>ğŸ“­ æš‚æ— æ–°é—»</h3><p>è¯·å°è¯•åˆ·æ–°æˆ–é€‰æ‹©å…¶ä»–ç±»åˆ«</p></div>';
        return;
      }

      newsReader.innerHTML = '';
      
      newsData.forEach((item, index) => {
        const newsItem = createNewsItem(item, index);
        newsReader.appendChild(newsItem);
      });
    }

    // åˆ›å»ºæ–°é—»é¡¹
    function createNewsItem(item, index) {
      const newsItem = document.createElement('div');
      newsItem.className = 'news-item';
      
      const timestamp = new Date(item.datetime * 1000);
      const timeStr = formatTime(timestamp);
      const isSaved = savedNews.some(saved => saved.id === item.id);
      const isAnalyzed = analyzedNews.some(analyzed => analyzed.id === item.id);
      
      if (isSaved) newsItem.classList.add('saved');
      if (isAnalyzed) newsItem.classList.add('important');
      
      newsItem.innerHTML = `
        <div class="news-meta">
          <span class="news-source">${item.source || 'Finnhub'}</span>
          <span class="news-time">ğŸ• ${timeStr}</span>
        </div>
        <div class="news-title">${item.headline || 'æ— æ ‡é¢˜'}</div>
        <div class="news-summary">${item.summary || 'æš‚æ— æ‘˜è¦'}</div>
        <div class="news-actions">
          <button class="action-btn btn-save ${isSaved ? 'saved' : ''}" 
                  onclick="toggleSave(${index})">
            ${isSaved ? 'âœ… å·²ä¿å­˜' : 'ğŸ’¾ ä¿å­˜'}
          </button>
          <button class="action-btn btn-analyze" 
                  onclick="analyzeNews(${index})">
            ğŸ§  åˆ†æ
          </button>
          <button class="action-btn btn-share" 
                  onclick="shareNews(${index})">
            ğŸ“¤ åˆ†äº«
          </button>
        </div>
      `;
      
      return newsItem;
    }

    // åˆ‡æ¢ä¿å­˜çŠ¶æ€
    function toggleSave(index) {
      const item = filteredNewsData[index];
      const existingIndex = savedNews.findIndex(saved => saved.id === item.id);
      
      if (existingIndex > -1) {
        savedNews.splice(existingIndex, 1);
      } else {
        item.id = item.id || Date.now() + Math.random();
        savedNews.push(item);
      }
      
      localStorage.setItem('savedNews', JSON.stringify(savedNews));
      displayNews(filteredNewsData);
      updateStats();
    }

    // åˆ†ææ–°é—»
    function analyzeNews(index) {
      const item = filteredNewsData[index];
      
      // ç®€å•çš„å…³é”®è¯åˆ†æ
      const positiveKeywords = ['å¢é•¿', 'ä¸Šæ¶¨', 'ç›ˆåˆ©', 'åˆ©å¥½', 'çªç ´', 'åˆ›æ–°', 'æˆåŠŸ', 'æ”¶ç›Š'];
      const negativeKeywords = ['ä¸‹è·Œ', 'äºæŸ', 'é£é™©', 'å±æœº', 'è­¦å‘Š', 'ä¸‹é™', 'å¤±è´¥', 'æŸå¤±'];
      
      const text = (item.headline + ' ' + item.summary).toLowerCase();
      const positiveCount = positiveKeywords.filter(keyword => text.includes(keyword)).length;
      const negativeCount = negativeKeywords.filter(keyword => text.includes(keyword)).length;
      
      const sentiment = positiveCount > negativeCount ? 'positive' : 
                      negativeCount > positiveCount ? 'negative' : 'neutral';
      
      const analysis = {
        id: item.id || Date.now() + Math.random(),
        sentiment: sentiment,
        positiveScore: positiveCount,
        negativeScore: negativeCount,
        analyzedAt: new Date().toISOString()
      };
      
      const existingIndex = analyzedNews.findIndex(analyzed => analyzed.id === item.id);
      if (existingIndex > -1) {
        analyzedNews[existingIndex] = analysis;
      } else {
        analyzedNews.push(analysis);
      }
      
      localStorage.setItem('analyzedNews', JSON.stringify(analyzedNews));
      displayNews(filteredNewsData);
      updateSentimentAnalysis();
      updateStats();
      
      alert(`åˆ†æå®Œæˆï¼æƒ…ç»ª: ${sentiment === 'positive' ? 'ç§¯æ' : sentiment === 'negative' ? 'æ¶ˆæ' : 'ä¸­æ€§'}`);
    }

    // åˆ†äº«æ–°é—»
    function shareNews(index) {
      const item = filteredNewsData[index];
      const shareText = `${item.headline}\n\n${item.summary}\n\næ¥æº: ${item.source}`;
      
      if (navigator.share) {
        navigator.share({
          title: item.headline,
          text: shareText,
          url: item.url || window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          alert('æ–°é—»å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        });
      }
    }

    // æ›´æ–°æƒ…æ„Ÿåˆ†æ
    function updateSentimentAnalysis() {
      const totalAnalyzed = analyzedNews.length;
      const positiveCount = analyzedNews.filter(item => item.sentiment === 'positive').length;
      const negativeCount = analyzedNews.filter(item => item.sentiment === 'negative').length;
      const neutralCount = totalAnalyzed - positiveCount - negativeCount;
      
      const overallSentiment = totalAnalyzed > 0 ? 
        (positiveCount - negativeCount) / totalAnalyzed : 0;
      
      // æ›´æ–°æƒ…æ„Ÿåˆ†æå¡ç‰‡
      const sentimentCards = sentimentPanel.querySelectorAll('.sentiment-card');
      
      // æ•´ä½“æƒ…ç»ª
      sentimentCards[0].querySelector('.sentiment-score').textContent = overallSentiment.toFixed(1);
      sentimentCards[0].querySelector('.sentiment-description').textContent = 
        overallSentiment > 0.1 ? 'ç§¯æ' : overallSentiment < -0.1 ? 'æ¶ˆæ' : 'ä¸­æ€§';
      sentimentCards[0].className = `sentiment-card ${overallSentiment > 0.1 ? 'positive' : overallSentiment < -0.1 ? 'negative' : 'neutral'}`;
      
      // æ­£é¢æ–°é—»
      sentimentCards[1].querySelector('.sentiment-score').textContent = positiveCount;
      
      // è´Ÿé¢æ–°é—»
      sentimentCards[2].querySelector('.sentiment-score').textContent = negativeCount;
    }

    // æ‰§è¡Œæœç´¢
    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase();
      const sourceFilterValue = sourceFilter.value;
      
      filteredNewsData = allNewsData.filter(item => {
        const matchesSearch = !searchTerm || 
          (item.headline && item.headline.toLowerCase().includes(searchTerm)) ||
          (item.summary && item.summary.toLowerCase().includes(searchTerm));
        
        const matchesSource = sourceFilterValue === 'all' || item.source === sourceFilterValue;
        
        return matchesSearch && matchesSource;
      });
      
      displayNews(filteredNewsData);
    }

    // ä¿å­˜æ‰€æœ‰æ–°é—»
    function saveAllNews() {
      const unsavedNews = filteredNewsData.filter(item => 
        !savedNews.some(saved => saved.id === item.id)
      );
      
      unsavedNews.forEach(item => {
        item.id = item.id || Date.now() + Math.random();
        savedNews.push(item);
      });
      
      localStorage.setItem('savedNews', JSON.stringify(savedNews));
      displayNews(filteredNewsData);
      updateStats();
      
      alert(`å·²ä¿å­˜ ${unsavedNews.length} æ¡æ–°é—»ï¼`);
    }

    // åˆ†ææ‰€æœ‰æ–°é—»
    function analyzeAllNews() {
      const unanalyzedNews = filteredNewsData.filter(item => 
        !analyzedNews.some(analyzed => analyzed.id === item.id)
      );
      
      unanalyzedNews.forEach(item => {
        const positiveKeywords = ['å¢é•¿', 'ä¸Šæ¶¨', 'ç›ˆåˆ©', 'åˆ©å¥½', 'çªç ´', 'åˆ›æ–°', 'æˆåŠŸ', 'æ”¶ç›Š'];
        const negativeKeywords = ['ä¸‹è·Œ', 'äºæŸ', 'é£é™©', 'å±æœº', 'è­¦å‘Š', 'ä¸‹é™', 'å¤±è´¥', 'æŸå¤±'];
        
        const text = (item.headline + ' ' + item.summary).toLowerCase();
        const positiveCount = positiveKeywords.filter(keyword => text.includes(keyword)).length;
        const negativeCount = negativeKeywords.filter(keyword => text.includes(keyword)).length;
        
        const sentiment = positiveCount > negativeCount ? 'positive' : 
                        negativeCount > positiveCount ? 'negative' : 'neutral';
        
        const analysis = {
          id: item.id || Date.now() + Math.random(),
          sentiment: sentiment,
          positiveScore: positiveCount,
          negativeScore: negativeCount,
          analyzedAt: new Date().toISOString()
        };
        
        analyzedNews.push(analysis);
      });
      
      localStorage.setItem('analyzedNews', JSON.stringify(analyzedNews));
      displayNews(filteredNewsData);
      updateSentimentAnalysis();
      updateStats();
      
      alert(`å·²åˆ†æ ${unanalyzedNews.length} æ¡æ–°é—»ï¼`);
    }

    // å¯¼å‡ºæ•°æ®
    function exportData(format) {
      const data = {
        news: savedNews,
        analysis: analyzedNews,
        exportedAt: new Date().toISOString()
      };
      
      let content, filename, mimeType;
      
      switch (format) {
        case 'json':
          content = JSON.stringify(data, null, 2);
          filename = `finnhub-data-${new Date().toISOString().split('T')[0]}.json`;
          mimeType = 'application/json';
          break;
        case 'csv':
          content = convertToCSV(data);
          filename = `finnhub-data-${new Date().toISOString().split('T')[0]}.csv`;
          mimeType = 'text/csv';
          break;
        case 'pdf':
          // ç®€å•çš„PDFå¯¼å‡ºï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨ä¸“ä¸šåº“ï¼‰
          content = generatePDFContent(data);
          filename = `finnhub-data-${new Date().toISOString().split('T')[0]}.txt`;
          mimeType = 'text/plain';
          break;
      }
      
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      
      // æ›´æ–°å¯¼å‡ºè®¡æ•°
      const currentCount = parseInt(exportCount.textContent) || 0;
      exportCount.textContent = currentCount + 1;
    }

    // è½¬æ¢ä¸ºCSV
    function convertToCSV(data) {
      const headers = ['æ ‡é¢˜', 'æ¥æº', 'æ—¶é—´', 'æƒ…ç»ª', 'æ­£é¢åˆ†æ•°', 'è´Ÿé¢åˆ†æ•°', 'åˆ†ææ—¶é—´'];
      const rows = data.news.map((news, index) => {
        const analysis = data.analysis.find(a => a.id === news.id) || {};
        return [
          news.headline || '',
          news.source || '',
          new Date(news.datetime * 1000).toLocaleString(),
          analysis.sentiment || '',
          analysis.positiveScore || '',
          analysis.negativeScore || '',
          analysis.analyzedAt || ''
        ];
      });
      
      return [headers, ...rows].map(row => 
        row.map(field => `"${field}"`).join(',')
      ).join('\n');
    }

    // ç”ŸæˆPDFå†…å®¹
    function generatePDFContent(data) {
      let content = 'FinnhubæŠ•èµ„ä»ªè¡¨æ¿æ•°æ®æŠ¥å‘Š\n';
      content += '='.repeat(50) + '\n\n';
      content += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
      content += `ä¿å­˜æ–°é—»æ•°: ${data.news.length}\n`;
      content += `åˆ†ææ–‡ç« æ•°: ${data.analysis.length}\n\n`;
      
      content += 'æ–°é—»åˆ—è¡¨:\n';
      content += '-'.repeat(30) + '\n';
      data.news.forEach((news, index) => {
        content += `${index + 1}. ${news.headline}\n`;
        content += `   æ¥æº: ${news.source}\n`;
        content += `   æ—¶é—´: ${new Date(news.datetime * 1000).toLocaleString()}\n`;
        content += `   æ‘˜è¦: ${news.summary}\n\n`;
      });
      
      return content;
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(status) {
      switch (status) {
        case 'connecting':
          statusDot.className = 'status-dot';
          statusText.textContent = 'è¿æ¥ä¸­...';
          break;
        case 'connected':
          statusDot.className = 'status-dot';
          statusText.textContent = 'å·²è¿æ¥';
          isConnected = true;
          break;
        case 'disconnected':
          statusDot.className = 'status-dot disconnected';
          statusText.textContent = 'è¿æ¥æ–­å¼€';
          isConnected = false;
          break;
      }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
      totalSaved.textContent = savedNews.length;
      analyzedCount.textContent = analyzedNews.length;
      lastUpdate.textContent = new Date().toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
      newsReader.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <h3>æ­£åœ¨åŠ è½½æ–°é—»...</h3>
          <p>è¯·ç¨å€™</p>
        </div>
      `;
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      newsReader.innerHTML = `
        <div class="loading">
          <h3>âš ï¸ é”™è¯¯</h3>
          <p>${message}</p>
        </div>
      `;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return 'åˆšåˆš';
      if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é’Ÿå‰`;
      if (diff < 86400) return `${Math.floor(diff / 3600)} å°æ—¶å‰`;
      if (diff < 604800) return `${Math.floor(diff / 86400)} å¤©å‰`;
      
      return date.toLocaleDateString('zh-CN');
    }

    // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
    function showExportOptions() {
      alert('è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n1. JSON - å®Œæ•´æ•°æ®\n2. CSV - è¡¨æ ¼æ ¼å¼\n3. PDF - æŠ¥å‘Šæ ¼å¼');
    }

    // æ˜¾ç¤ºè®¾ç½®
    function showSettings() {
      alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...\n\nå°†åŒ…æ‹¬ï¼š\n- APIå¯†é’¥ç®¡ç†\n- è‡ªåŠ¨åˆ·æ–°é—´éš”\n- æ•°æ®ä¿å­˜é€‰é¡¹\n- é€šçŸ¥è®¾ç½®');
    }

    // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
    window.toggleSave = toggleSave;
    window.analyzeNews = analyzeNews;
    window.shareNews = shareNews;
  </script>
</Layout>










