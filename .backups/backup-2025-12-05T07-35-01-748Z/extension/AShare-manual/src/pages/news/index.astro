---
/**
 * å®æ—¶æ–°é—»ä¸­å¿ƒ - ä¸»é¡µ
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºä»Šæ—¥é‡è¦æ–°é—»ã€AIæ€»ç»“ã€æŠ•èµ„è§‚ç‚¹ã€æ—¥æœŸé€‰æ‹©
 */
import Layout from '../../layouts/Layout.astro';
import DateSelector from '../../components/DateSelector.astro';
import { readdir, readFile } from 'fs/promises';
import { join } from 'path';

// è·å–URLå‚æ•°ä¸­çš„æ—¥æœŸ
const url = new URL(Astro.request.url);
const dateParam = url.searchParams.get('date');

// è¯»å–æŒ‡å®šæ—¥æœŸæˆ–æœ€æ–°æ–°é—»æ•°æ®
async function loadLatestNews(targetDate?: string) {
  try {
    const realtimeDir = join(process.cwd(), '../data-sources/storage/news/realtime');
    const wsjDir = join(process.cwd(), '../data-sources/storage/news/wsj');
    const today = targetDate || new Date().toISOString().split('T')[0].replace(/-/g, '').slice(0, 8);
    
    let allArticles = [];
    let summary = null;
    
    // 1. ä¼˜å…ˆè¯»å–Google Newsæ•°æ®
    try {
      const realtimeFiles = await readdir(realtimeDir);
      const googleNewsFiles = realtimeFiles
        .filter(f => f.includes('google_news') && f.includes(today) && f.endsWith('.json'))
        .sort()
        .reverse();
      
      if (googleNewsFiles.length > 0) {
        const filePath = join(realtimeDir, googleNewsFiles[0]);
        const content = await readFile(filePath, 'utf-8');
        allArticles = JSON.parse(content);
        console.log(`âœ… åŠ è½½Google News: ${allArticles.length} æ¡æ–°é—»`);
        
        // è¯»å–æ€»ç»“
        const summaryFiles = realtimeFiles
          .filter(f => f.includes('summary') && f.includes(today) && f.endsWith('.json'))
          .sort()
          .reverse();
        
        if (summaryFiles.length > 0) {
          const summaryPath = join(realtimeDir, summaryFiles[0]);
          summary = JSON.parse(await readFile(summaryPath, 'utf-8'));
        }
      }
    } catch (e) {
      console.log('Google Newsæ•°æ®ä¸å¯ç”¨ï¼Œå°è¯•WSJ...');
    }
    
    // 2. å¦‚æœGoogle Newsæ•°æ®ä¸è¶³ï¼Œè¡¥å……WSJæ•°æ®
    if (allArticles.length < 20) {
      try {
        const wsjFiles = await readdir(wsjDir);
        const todayWsjFiles = wsjFiles
          .filter(f => f.includes(today) && f.endsWith('.json'))
          .sort()
          .reverse();
        
        for (const file of todayWsjFiles.slice(0, 3)) { // æœ€å¤šè¯»å–3ä¸ªWSJæ–‡ä»¶
          const filePath = join(wsjDir, file);
          const content = await readFile(filePath, 'utf-8');
          const wsjArticles = JSON.parse(content);
          
          // è½¬æ¢WSJæ•°æ®æ ¼å¼ä»¥åŒ¹é…Google Newsæ ¼å¼
          const convertedArticles = wsjArticles.map(article => ({
            source: 'wsj',
            title: article.title,
            url: article.url,
            timestamp: article.timestamp,
            collected_at: article.collected_at || new Date().toISOString(),
            category: article.category === 'markets' ? 'stocks' : 
                     article.category === 'world' ? 'economy' : 
                     article.category === 'opinion' ? 'business' : 'stocks',
            type: 'news',
            source_name: 'Wall Street Journal',
            summary: article.content || ''
          }));
          
          allArticles = allArticles.concat(convertedArticles);
        }
        console.log(`âœ… è¡¥å……WSJæ•°æ®: æ€»è®¡ ${allArticles.length} æ¡æ–°é—»`);
      } catch (e) {
        console.log('WSJæ•°æ®ä¸å¯ç”¨');
      }
    }
    
    // 3. æŒ‰ç±»åˆ«åˆ†ç»„
    const byCategory = {
      stocks: allArticles.filter(a => a.category === 'stocks'),
      tech: allArticles.filter(a => a.category === 'tech'),
      business: allArticles.filter(a => a.category === 'business'),
      economy: allArticles.filter(a => a.category === 'economy')
    };
    
    // 4. å¦‚æœæ²¡æœ‰æ€»ç»“ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„
    if (!summary && allArticles.length > 0) {
      const sources = [...new Set(allArticles.map(a => a.source_name))];
      const categories = Object.keys(byCategory).filter(cat => byCategory[cat].length > 0);
      
      summary = {
        date: today,
        total_articles: allArticles.length,
        categories: Object.fromEntries(
          Object.entries(byCategory).map(([cat, articles]) => [cat, articles.length])
        ),
        top_sources: Object.fromEntries(
          sources.slice(0, 5).map(source => [
            source, 
            allArticles.filter(a => a.source_name === source).length
          ])
        ),
        hot_keywords: {
          'market': allArticles.filter(a => a.title.toLowerCase().includes('market')).length,
          'stock': allArticles.filter(a => a.title.toLowerCase().includes('stock')).length,
          'earnings': allArticles.filter(a => a.title.toLowerCase().includes('earnings')).length,
          'fed': allArticles.filter(a => a.title.toLowerCase().includes('fed')).length
        }
      };
    }
    
    return { articles: byCategory, summary, total: allArticles.length };
  } catch (error) {
    console.error('Error loading news:', error);
    return { articles: {}, summary: null, total: 0 };
  }
}

const { articles, summary, total } = await loadLatestNews(dateParam || undefined);
const now = new Date();
const displayDate = dateParam 
  ? new Date(dateParam.slice(0, 4) + '-' + dateParam.slice(4, 6) + '-' + dateParam.slice(6, 8))
  : now;
---

<Layout title="å®æ—¶æ–°é—»ä¸­å¿ƒ">
  <style>
    /* ä¸»å®¹å™¨ */
    .news-hub {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* é¡µé¢å¤´éƒ¨ */
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .page-header h1 {
      font-size: 2.8em;
      margin: 0 0 10px 0;
      font-weight: 700;
    }

    .page-header .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .header-meta {
      display: flex;
      gap: 30px;
      font-size: 0.95em;
      opacity: 0.95;
    }

    .header-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .stat-card h3 {
      font-size: 0.9em;
      color: #666;
      margin: 0 0 10px 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .number {
      font-size: 2.5em;
      font-weight: 700;
      color: #667eea;
      margin: 0;
    }

    /* AIæ€»ç»“åŒºåŸŸ */
    .ai-summary {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .ai-summary h2 {
      font-size: 1.8em;
      margin: 0 0 20px 0;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .summary-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .summary-section h4 {
      font-size: 1.1em;
      margin: 0 0 15px 0;
      color: #4a5568;
      font-weight: 600;
    }

    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      background: #667eea;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .tag:hover {
      background: #764ba2;
      transform: scale(1.05);
    }

    /* æŠ•èµ„è§‚ç‚¹ */
    .investment-insight {
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      border-left: 5px solid #f59e0b;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .investment-insight h3 {
      font-size: 1.5em;
      margin: 0 0 15px 0;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .insight-content {
      font-size: 1.05em;
      line-height: 1.8;
      color: #4a5568;
    }

    .insight-highlight {
      background: #fef3c7;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      font-weight: 500;
    }

    /* åˆ†ç±»å¯¼èˆª */
    .category-nav {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .category-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: white;
      border-radius: 30px;
      text-decoration: none;
      color: #4a5568;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .category-link:hover {
      background: #667eea;
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .category-icon {
      font-size: 1.5em;
    }

    /* æ–°é—»å¡ç‰‡ */
    .news-section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 1.8em;
      margin: 0 0 20px 0;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 3px solid #667eea;
    }

    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .news-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .news-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .news-card h3 {
      font-size: 1.15em;
      margin: 0 0 12px 0;
      line-height: 1.5;
      color: #2d3748;
    }

    .news-card h3 a {
      color: inherit;
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .news-card h3 a:hover {
      color: #667eea;
    }

    .news-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 0.85em;
      color: #718096;
      margin-bottom: 12px;
    }

    .news-source {
      background: #edf2f7;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      color: #4a5568;
    }

    .news-time {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 5em;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2em;
      }
      
      .news-grid {
        grid-template-columns: 1fr;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }

      .category-nav {
        justify-content: center;
      }
    }
  </style>

  <div class="news-hub">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="page-header">
      <h1>ğŸ“° å®æ—¶æ–°é—»ä¸­å¿ƒ</h1>
      <p class="subtitle">å¤šæºèšåˆ Â· æ™ºèƒ½åˆ†æ Â· æŠ•èµ„æ´å¯Ÿ</p>
      <div class="header-meta">
        <div class="header-meta-item">
          <span>ğŸ“…</span>
          <span>{displayDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
        </div>
        <div class="header-meta-item">
          <span>ğŸ•</span>
          <span>{now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        <div class="header-meta-item">
          <span>ğŸ“Š</span>
          <span>{total} æ¡æ–°é—»</span>
        </div>
      </div>
    </header>

    <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
    <DateSelector />

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-container">
      <div class="stat-card">
        <h3>ğŸ“ˆ è‚¡ç¥¨æ–°é—»</h3>
        <p class="number">{articles.stocks?.length || 0}</p>
      </div>
      <div class="stat-card">
        <h3>ğŸ’» ç§‘æŠ€æ–°é—»</h3>
        <p class="number">{articles.tech?.length || 0}</p>
      </div>
      <div class="stat-card">
        <h3>ğŸ’¼ å•†ä¸šæ–°é—»</h3>
        <p class="number">{articles.business?.length || 0}</p>
      </div>
      <div class="stat-card">
        <h3>ğŸ’° ç»æµæ–°é—»</h3>
        <p class="number">{articles.economy?.length || 0}</p>
      </div>
    </div>

    <!-- AIæ€»ç»“ -->
    {summary && (
      <div class="ai-summary">
        <h2>
          <span>ğŸ¤–</span>
          <span>AI æ–°é—»æ€»ç»“</span>
        </h2>
        <div class="summary-grid">
          <div class="summary-section">
            <h4>ğŸ”¥ çƒ­é—¨å…³é”®è¯</h4>
            <div class="tag-cloud">
              {Object.entries(summary.hot_keywords || {}).slice(0, 8).map(([keyword, count]) => (
                <span class="tag">{keyword} ({count})</span>
              ))}
            </div>
          </div>
          <div class="summary-section">
            <h4>ğŸ“° ä¸»è¦æ¥æº</h4>
            <div class="tag-cloud">
              {Object.entries(summary.top_sources || {}).slice(0, 5).map(([source, count]) => (
                <span class="tag">{source} ({count})</span>
              ))}
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- æŠ•èµ„è§‚ç‚¹ -->
    <div class="investment-insight">
      <h3>
        <span>ğŸ’¡</span>
        <span>AI æŠ•èµ„è§‚ç‚¹</span>
      </h3>
      <div class="insight-content">
        <p>åŸºäºä»Šæ—¥ {total} æ¡æ–°é—»çš„ç»¼åˆåˆ†æï¼š</p>
        <div class="insight-highlight">
          ğŸ“Š <strong>å¸‚åœºæƒ…ç»ª</strong>: {summary && Object.keys(summary.hot_keywords || {}).includes('earnings') ? 'è´¢æŠ¥å­£æŒç»­ï¼Œå¸‚åœºå…³æ³¨ä¼ä¸šç›ˆåˆ©è¡¨ç°' : 'å¸‚åœºä¿æŒè§‚æœ›æ€åº¦ï¼Œå…³æ³¨å®è§‚ç»æµæ•°æ®'}
          <br><br>
          ğŸ¯ <strong>å…³æ³¨æ¿å—</strong>: {summary && (Object.keys(summary.hot_keywords || {}).includes('stock') || Object.keys(summary.hot_keywords || {}).includes('stocks')) ? 'è‚¡å¸‚æ´»è·ƒåº¦é«˜ï¼Œå»ºè®®å…³æ³¨ç§‘æŠ€ã€æ¶ˆè´¹æ¿å—' : 'å¤šå…ƒåŒ–é…ç½®ï¼Œå…³æ³¨é˜²å¾¡æ€§æ¿å—'}
          <br><br>
          âš ï¸ <strong>é£é™©æç¤º</strong>: å¸‚åœºæ³¢åŠ¨åŠ å¤§ï¼Œå»ºè®®æ§åˆ¶ä»“ä½ï¼Œåšå¥½é£é™©ç®¡ç†
        </div>
      </div>
    </div>

    <!-- åˆ†ç±»å¯¼èˆª -->
    <div class="category-nav">
      <a href="/news/stocks" class="category-link">
        <span class="category-icon">ğŸ“ˆ</span>
        <span>è‚¡ç¥¨æ¿å—</span>
      </a>
      <a href="/news/tech" class="category-link">
        <span class="category-icon">ğŸ’»</span>
        <span>ç§‘æŠ€æ¿å—</span>
      </a>
      <a href="/news/business" class="category-link">
        <span class="category-icon">ğŸ’¼</span>
        <span>å•†ä¸šæ¿å—</span>
      </a>
      <a href="/news/economy" class="category-link">
        <span class="category-icon">ğŸ’°</span>
        <span>ç»æµæ¿å—</span>
      </a>
    </div>

    <!-- è‚¡ç¥¨æ–°é—» -->
    <section class="news-section">
      <h2 class="section-title">
        <span>ğŸ“ˆ</span>
        <span>è‚¡ç¥¨æ–°é—»</span>
      </h2>
      {articles.stocks && articles.stocks.length > 0 ? (
        <div class="news-grid">
          {articles.stocks.slice(0, 6).map((article) => (
            <article class="news-card">
              <h3><a href={article.url} target="_blank" rel="noopener noreferrer">{article.title}</a></h3>
              <div class="news-meta">
                <span class="news-source">{article.source_name}</span>
                <span class="news-time">
                  <span>ğŸ•</span>
                  <span>{new Date(article.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>
                </span>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“°</div>
          <h3>æš‚æ— è‚¡ç¥¨æ–°é—»</h3>
        </div>
      )}
    </section>

    <!-- ç§‘æŠ€æ–°é—» -->
    <section class="news-section">
      <h2 class="section-title">
        <span>ğŸ’»</span>
        <span>ç§‘æŠ€æ–°é—»</span>
      </h2>
      {articles.tech && articles.tech.length > 0 ? (
        <div class="news-grid">
          {articles.tech.slice(0, 6).map((article) => (
            <article class="news-card">
              <h3><a href={article.url} target="_blank" rel="noopener noreferrer">{article.title}</a></h3>
              <div class="news-meta">
                <span class="news-source">{article.source_name}</span>
                <span class="news-time">
                  <span>ğŸ•</span>
                  <span>{new Date(article.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</span>
                </span>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’»</div>
          <h3>æš‚æ— ç§‘æŠ€æ–°é—»</h3>
        </div>
      )}
    </section>
  </div>
</Layout>

