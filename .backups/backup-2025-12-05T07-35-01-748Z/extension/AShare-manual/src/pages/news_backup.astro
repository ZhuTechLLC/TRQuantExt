---
// æ–°é—»èšåˆä¸­å¿ƒ - å®Œæ•´çš„æ–°é—»é˜…è¯»å™¨
import Layout from '../layouts/Layout.astro';
import { readdir, readFile } from 'fs/promises';
import { join } from 'path';

// è¯»å–æœ€æ–°çš„æ–°é—»æ•°æ®
async function getLatestNews() {
  try {
    // ä¼˜å…ˆè¯»å–å®æ—¶æ–°é—»
    const realtimeDir = join(process.cwd(), '../data-sources/storage/news/realtime');
    
    try {
      const realtimeFiles = await readdir(realtimeDir);
      const today = new Date().toISOString().split('T')[0].replace(/-/g, '').slice(0, 8);
      
      // æŸ¥æ‰¾ä»Šå¤©çš„Google Newsæ–‡ä»¶
      const googleNewsFiles = realtimeFiles
        .filter(f => f.includes('google_news') && f.includes(today) && f.endsWith('.json'))
        .sort()
        .reverse();
      
      if (googleNewsFiles.length > 0) {
        const latestFile = googleNewsFiles[0];
        const filePath = join(realtimeDir, latestFile);
        const content = await readFile(filePath, 'utf-8');
        const allArticles = JSON.parse(content);
        
        console.log(`âœ… Loading realtime news from ${latestFile}: ${allArticles.length} articles`);
        
        // æŒ‰ç±»åˆ«åˆ†ç»„
        const newsData = {
          stocks: [],
          tech: [],
          business: [],
          economy: []
        };
        
        for (const article of allArticles) {
          const category = article.category || 'stocks';
          if (newsData[category]) {
            newsData[category].push(article);
          }
        }
        
        // è¯»å–æ€»ç»“æ–‡ä»¶
        const summaryFiles = realtimeFiles
          .filter(f => f.includes('summary') && f.includes(today) && f.endsWith('.json'))
          .sort()
          .reverse();
        
        let summary = null;
        if (summaryFiles.length > 0) {
          const summaryPath = join(realtimeDir, summaryFiles[0]);
          const summaryContent = await readFile(summaryPath, 'utf-8');
          summary = JSON.parse(summaryContent);
        }
        
        return { newsData, summary };
      }
    } catch (e) {
      console.log('No realtime news found, falling back to WSJ RSS');
    }
    
    // é™çº§åˆ°WSJ RSS
    const wsjDir = join(process.cwd(), '../data-sources/storage/news/wsj');
    const files = await readdir(wsjDir);
    const today = new Date().toISOString().split('T')[0].replace(/-/g, '').slice(0, 8);
    const todayFiles = files.filter(f => f.includes(today) && f.endsWith('.json'));
    
    const newsData = {
      markets: [],
      world: [],
      opinion: []
    };
    
    const filesByCategory = {
      markets: todayFiles.filter(f => f.includes('markets')).sort().reverse(),
      world: todayFiles.filter(f => f.includes('world')).sort().reverse(),
      opinion: todayFiles.filter(f => f.includes('opinion')).sort().reverse()
    };
    
    for (const [category, categoryFiles] of Object.entries(filesByCategory)) {
      if (categoryFiles.length > 0) {
        const filePath = join(wsjDir, categoryFiles[0]);
        const content = await readFile(filePath, 'utf-8');
        const data = JSON.parse(content);
        newsData[category] = data.slice(0, 10);
      }
    }
    
    return { newsData, summary: null };
  } catch (error) {
    console.error('Error loading news:', error);
    return { newsData: {}, summary: null };
  }
}

const result = await getLatestNews();
const newsData = result.newsData || {};
const summary = result.summary;

// è®¡ç®—æ€»æ•°
let totalNews = 0;
for (const articles of Object.values(newsData)) {
  if (Array.isArray(articles)) {
    totalNews += articles.length;
  }
}

---

<Layout title="æ–°é—»èšåˆä¸­å¿ƒ" currentBook="news">
  <style>
    .news-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .page-header {
      text-align: center;
      padding: 40px 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .page-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .news-section {
      margin-bottom: 50px;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    .section-header h2 {
      font-size: 1.8rem;
      color: #333;
      margin: 0;
    }
    
    .section-badge {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      margin-left: 15px;
      font-weight: 600;
    }
    
    .news-grid {
      display: grid;
      gap: 20px;
    }
    
    .news-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }
    
    .news-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      transform: translateX(5px);
    }
    
    .news-title {
      font-size: 1.3rem;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .news-title a {
      color: #333;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    
    .news-title a:hover {
      color: #667eea;
    }
    
    .news-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      color: #666;
      font-size: 0.9rem;
    }
    
    .news-time {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .news-source {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      background: #f0f0f0;
      border-radius: 12px;
    }
    
    .news-content {
      color: #555;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .news-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 15px;
    }
    
    .tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .entities-badge {
      background: #fff3cd;
      color: #856404;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .data-sources {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 50px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }
    
    .source-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .source-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }
    
    .source-card h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 1.2rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-manual {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-pending {
      background: #f8d7da;
      color: #721c24;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }
      
      .news-page {
        padding: 10px;
      }
      
      .news-card {
        padding: 15px;
      }
    }
  </style>

  <div class="news-page">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <header class="page-header">
      <h1>ğŸ“° æ–°é—»èšåˆä¸­å¿ƒ</h1>
      <p>WSJ å®æ—¶æ–°é—» Â· å¸‚åœºæ´å¯Ÿ Â· æŠ•èµ„å†³ç­–</p>
    </header>

    <!-- ç»Ÿè®¡æ•°æ® -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>ä»Šæ—¥æ–°é—»</h3>
        <div class="stat-number">{totalNews}</div>
        <p style="margin: 0; opacity: 0.8;">æ¡æ–°é—»</p>
      </div>
      <div class="stat-card">
        <h3>è‚¡ç¥¨æ–°é—»</h3>
        <div class="stat-number">{newsData.stocks?.length || 0}</div>
        <p style="margin: 0; opacity: 0.8;">ç¯‡æ–‡ç« </p>
      </div>
      <div class="stat-card">
        <h3>ç§‘æŠ€æ–°é—»</h3>
        <div class="stat-number">{newsData.tech?.length || 0}</div>
        <p style="margin: 0; opacity: 0.8;">ç¯‡æ–‡ç« </p>
      </div>
      <div class="stat-card">
        <h3>å•†ä¸šæ–°é—»</h3>
        <div class="stat-number">{newsData.business?.length || 0}</div>
        <p style="margin: 0; opacity: 0.8;">ç¯‡æ–‡ç« </p>
      </div>
    </div>

    <!-- æ–°é—»æ€»ç»“ -->
    {summary && (
      <div class="summary-section">
        <h2>ğŸ“Š ä»Šæ—¥æ–°é—»æ€»ç»“</h2>
        <div class="summary-content">
          <div class="summary-stats">
            <div class="summary-item">
              <strong>çƒ­é—¨å…³é”®è¯:</strong>
              {Object.entries(summary.hot_keywords || {}).slice(0, 5).map(([keyword, count]) => (
                <span class="keyword-tag">{keyword} ({count})</span>
              ))}
            </div>
            <div class="summary-item">
              <strong>ä¸»è¦æ¥æº:</strong>
              {Object.entries(summary.top_sources || {}).slice(0, 3).map(([source, count]) => (
                <span class="source-tag">{source} ({count})</span>
              ))}
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- å¸‚åœºæ–°é—» -->
    <section class="news-section">
      <div class="section-header">
        <h2>ğŸ“ˆ å¸‚åœºæ–°é—»</h2>
        <span class="section-badge">{newsData.markets.length} ç¯‡</span>
      </div>
      
      {newsData.markets.length > 0 ? (
        <div class="news-grid">
          {newsData.markets.map((article: any) => (
            <article class="news-card">
              <h3 class="news-title">
                <a href={article.url} target="_blank" rel="noopener noreferrer">
                  {article.title}
                </a>
              </h3>
              <div class="news-meta">
                <span class="news-time">
                  ğŸ“… å‘å¸ƒ: {new Date(article.timestamp).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </span>
                <span class="news-time">
                  ğŸ• é‡‡é›†: {new Date(article.collected_at).toLocaleString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </span>
                <span class="news-source">ğŸ“° WSJ {article.category}</span>
              </div>
              <div class="news-content">{article.content}</div>
              {article.entities && article.entities.length > 0 && (
                <div class="news-tags">
                  <span class="entities-badge">ğŸ·ï¸ ç›¸å…³:</span>
                  {article.entities.slice(0, 3).map((entity: any) => (
                    <span class="tag">{entity.value}</span>
                  ))}
                </div>
              )}
            </article>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>æš‚æ— å¸‚åœºæ–°é—»æ•°æ®</p>
        </div>
      )}
    </section>

    <!-- ä¸–ç•Œæ–°é—» -->
    <section class="news-section">
      <div class="section-header">
        <h2>ğŸŒ ä¸–ç•Œæ–°é—»</h2>
        <span class="section-badge">{newsData.world.length} ç¯‡</span>
      </div>
      
      {newsData.world.length > 0 ? (
        <div class="news-grid">
          {newsData.world.map((article: any) => (
            <article class="news-card">
              <h3 class="news-title">
                <a href={article.url} target="_blank" rel="noopener noreferrer">
                  {article.title}
                </a>
              </h3>
              <div class="news-meta">
                <span class="news-time">
                  ğŸ• {new Date(article.timestamp).toLocaleString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </span>
                <span class="news-source">ğŸ“° WSJ {article.category}</span>
              </div>
              <div class="news-content">{article.content}</div>
            </article>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>æš‚æ— ä¸–ç•Œæ–°é—»æ•°æ®</p>
        </div>
      )}
    </section>

    <!-- è§‚ç‚¹è¯„è®º -->
    <section class="news-section">
      <div class="section-header">
        <h2>ğŸ’­ è§‚ç‚¹è¯„è®º</h2>
        <span class="section-badge">{newsData.opinion.length} ç¯‡</span>
      </div>
      
      {newsData.opinion.length > 0 ? (
        <div class="news-grid">
          {newsData.opinion.map((article: any) => (
            <article class="news-card">
              <h3 class="news-title">
                <a href={article.url} target="_blank" rel="noopener noreferrer">
                  {article.title}
                </a>
              </h3>
              <div class="news-meta">
                <span class="news-time">
                  ğŸ• {new Date(article.timestamp).toLocaleString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </span>
                <span class="news-source">ğŸ“° WSJ {article.category}</span>
              </div>
              <div class="news-content">{article.content}</div>
            </article>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>æš‚æ— è§‚ç‚¹è¯„è®ºæ•°æ®</p>
        </div>
      )}
    </section>

    <!-- æ•°æ®æºçŠ¶æ€ -->
    <section class="data-sources">
      <div class="source-card">
        <h3>WSJ RSS</h3>
        <span class="status-badge status-active">âœ… æ´»è·ƒè¿è¡Œ</span>
        <p>æ¯æ—¥è‡ªåŠ¨é‡‡é›†15æ¡é«˜è´¨é‡æ–°é—»</p>
        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
          è¦†ç›–å¸‚åœºã€ä¸–ç•Œã€è§‚ç‚¹ä¸‰å¤§ç±»åˆ«
        </p>
      </div>
      
      <div class="source-card">
        <h3>WSJ PDF</h3>
        <span class="status-badge status-manual">ğŸ“„ æ‰‹åŠ¨æ¨¡å¼</span>
        <p>å®Œæ•´æŠ¥çº¸å†…å®¹ï¼Œéœ€æ‰‹åŠ¨ä¸‹è½½</p>
        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
          åŒ…å«æ·±åº¦åˆ†æå’Œç‹¬å®¶æŠ¥é“
        </p>
      </div>
      
      <div class="source-card">
        <h3>å…¶ä»–æ•°æ®æº</h3>
        <span class="status-badge status-pending">â³ å¼€å‘ä¸­</span>
        <p>MarketWatchã€IBDã€GuruFocus</p>
        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
          æ›´å¤šæ•°æ®æºå³å°†ä¸Šçº¿
        </p>
      </div>
    </section>
  </div>
</Layout>
