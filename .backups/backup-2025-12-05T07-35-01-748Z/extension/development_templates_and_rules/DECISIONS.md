# 架构与设计决策记录 (Decisions)

本文件记录项目在架构和设计上的关键决策，包括决策时间、内容、原因及考虑的替代方案。通过这些记录可以跟踪模块的演进和重要技术选择。

- **2025-12-01** 决策：采用"Web服务 + VSCode插件"双架构方案

  - **背景**：最初构想仅通过Web界面提供量化功能，但单人开发者希望充分利用VSCode提高开发效率，并使用AI模型辅助编码。

  - **方案权衡**：方案A是纯Web系统，用户在浏览器编写策略；方案B增加VSCode插件，开发者可在IDE中编写并运行策略。方案A实现简单但开发体验较弱，方案B开发略复杂但提升效率。

  - **决定**：选择方案B，即同时开发VSCode插件和后端Web服务，通过API连接两者。原因是插件能提供更优秀的开发者体验，充分发挥AI辅助编码优势，同时保留Web界面供其它用户使用。

  - **影响**：架构更复杂，需要设计清晰的API契约保证IDE与后端解耦；开发者需维护两套客户端，但长远看提高了系统可用性。

- **2025-12-10** 决策：引入`.cursor-rules.mdc`规范驱动AI代码生成

  - **背景**：在早期使用AI生成代码时，发现模型输出风格不统一、有时偏离项目约定，需频繁手工修改。

  - **方案权衡**：方案A是依赖开发者每次提示时重申规范；方案B是在项目中引入Cursor的规则文件，提供统一上下文约束AI行为。

  - **决定**：采用方案B，编写项目规则文件`.cursor-rules.mdc`存放在代码库，定义编码规范和架构提示。这样Claude模型在生成代码时会自动参考这些规则，减少风格偏差。

  - **影响**：需要维护规则文件随项目更新，但显著提升了AI生成代码的一致性，减少人工调整，长期降低token消耗和沟通成本。

- **2025-12-15** 决策：数据库从SQLite切换为PostgreSQL

  - **背景**：起初使用SQLite本地文件存储数据方便开发，但随着并发访问和数据量增长，其限制逐渐明显。

  - **方案权衡**：考虑过继续使用SQLite + 分库，或迁移到更健壮的数据库如PostgreSQL/MySQL。后者需额外部署但支持并发和复杂查询。

  - **决定**：迁移至PostgreSQL数据库。理由：PostgreSQL 在可靠性、并发性能和扩展性方面更符合生产需求；放弃SQLite方案是因为其锁机制无法满足高并发，且扩展性较差。

  - **影响**：后端数据层模块需要重构以使用PostgreSQL驱动，增加初始化和配置步骤；但长期提升了系统稳定性，并为将来功能扩展奠定基础。

- **2025-12-03** 决策：采用Python Bridge架构而非HTTP API

  - **背景**：最初考虑使用HTTP API连接TypeScript和Python，但需要额外的Web服务器，增加部署复杂度。

  - **方案权衡**：方案A是HTTP API（Flask/FastAPI），需要独立服务器；方案B是Python Bridge（stdin/stdout），直接子进程通信。方案A更灵活但需要额外服务，方案B更简单但耦合度较高。

  - **决定**：选择方案B（Python Bridge），通过stdin/stdout JSON协议通信。原因是扩展是本地应用，不需要网络通信，Bridge方式更直接高效，减少部署复杂度。

  - **影响**：需要严格管理子进程生命周期，确保资源正确释放；JSON协议需要严格验证，避免解析错误。

- **2025-12-03** 决策：策略优化器采用学习引擎架构

  - **背景**：策略优化器需要支持多平台转换、代码分析和报告生成，同时希望从A股实操手册中持续学习。

  - **方案权衡**：方案A是静态规则库，手动维护API映射；方案B是学习引擎，自动从文档和历史中学习。方案A简单但维护成本高，方案B复杂但可进化。

  - **决定**：采用方案B，实现学习引擎架构，包括文档学习、历史学习、反馈学习和手册学习。理由：知识库可以持续积累和进化，减少人工维护，提高转换准确性。

  - **影响**：需要实现知识存储、学习算法、推荐系统等复杂功能，但长期收益显著。

- **2025-12-03** 决策：使用WebView而非原生VS Code UI组件

  - **背景**：需要展示复杂的量化数据可视化（图表、表格、工作流），VS Code原生UI组件功能有限。

  - **方案权衡**：方案A是使用VS Code原生TreeView、QuickPick等组件；方案B是使用WebView自定义HTML/CSS/JS。方案A性能好但功能受限，方案B功能强大但性能略差。

  - **决定**：选择方案B（WebView），使用HTML/CSS/JS构建自定义界面。原因是量化系统需要丰富的可视化，WebView可以完全自定义，支持图表库、交互式界面。

  - **影响**：需要管理WebView生命周期，处理消息通信，但提供了最大的灵活性。

- **2025-12-03** 决策：项目模板使用外部文件而非内联字符串

  - **背景**：创建项目时需要生成策略模板代码，最初使用内联字符串，但模板复杂后难以维护。

  - **方案权衡**：方案A是内联模板字符串；方案B是外部模板文件。方案A简单但难以维护，方案B需要文件管理但更清晰。

  - **决定**：采用方案B，将模板文件放在`extension/templates/strategies/`目录，代码读取文件并替换变量。理由：模板可以独立编辑，支持版本控制，便于复用和扩展。

  - **影响**：需要管理模板文件，但提高了可维护性和可扩展性。

*(后续决策将按时间倒序添加在此列表，以方便查阅最新决策。)*

