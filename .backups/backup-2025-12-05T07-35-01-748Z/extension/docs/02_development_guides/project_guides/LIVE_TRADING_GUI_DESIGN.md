# 实盘交易GUI界面设计说明

## 界面概览

"韬睿量化平台启动器" → "实盘交易" 标签页

## 完整界面布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  实盘交易管理                                                           │
│  模块 3：实盘交易管理（连接券商、查看账户/持仓、下单、订单管理）        │
├─────────────────────────────────────────────────────────────────────────┤
│  [券商通道: QMT（国金）▼] [连接状态: 未连接] [连接] [断开] [刷新数据]  │
├──────────────────────────────┬──────────────────────────────────────────┤
│  左侧面板                    │  右侧面板                                    │
├──────────────────────────────┼──────────────────────────────────────────┤
│  ┌─ 账户信息 ───────────┐  │  ┌─ 持仓 ───────────────────────────┐   │
│  │ 总资产: 1,000,000.00 │  │  │ 代码  数量  成本价 当前价 市值  │   │
│  │ 可用资金: 500,000.00 │  │  │ 000001 1000  10.00  10.50  10500 │   │
│  │ 持仓市值: 500,000.00  │  │  │ ...                               │   │
│  │ 冻结资金: 0.00        │  │  └──────────────────────────────────┘   │
│  └───────────────────────┘  │                                          │
│  ┌─ 下单 ─────────────────┐ │  ┌─ 订单 ───────────────────────────┐   │
│  │ 股票代码: [000001.XSHE]│ │  │ 订单ID  代码  方向 数量 价格 状态 │   │
│  │ 数量:     [100]        │ │  │ QMT_xxx 000001 买入 100  10.00 已成交│
│  │ 价格类型: [市价▼]      │ │  │ ...                               │   │
│  │ 限价:     [0.00]       │ │  └──────────────────────────────────┘   │
│  │ [买入] [卖出]          │ │                                          │
│  └───────────────────────┘ │                                          │
└──────────────────────────────┴──────────────────────────────────────────┘
│  ┌─ 交易日志 ───────────────────────────────────────────────────────┐  │
│  │ [16:30:18] 正在连接 QMT...                                        │  │
│  │ [16:30:19] QMT连接成功                                            │  │
│  │ [16:30:20] 数据刷新完成                                           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 界面元素详细说明

### 1. 顶部控制栏

#### 1.1 券商通道选择
- **控件**: `Combobox` (下拉选择框)
- **选项**: 
  - "Ptrade（国金）" - 国金证券Ptrade云托管
  - "QMT（国金）" - 国金证券QMT本地终端
- **默认值**: QMT（国金）
- **功能**: 选择要连接的券商通道

#### 1.2 连接状态指示
- **控件**: `Label` (状态标签)
- **显示值**: 
  - "未连接" (红色)
  - "已连接" (绿色)
  - "连接失败" (红色)
- **功能**: 实时显示当前连接状态

#### 1.3 连接按钮
- **控件**: `Button` (主要按钮样式)
- **文本**: "连接"
- **功能**: 
  - 点击后连接选定的券商
  - 连接过程中按钮禁用
  - 连接成功后自动禁用，启用"断开"按钮
- **执行逻辑**:
  1. 检查QMT虚拟环境是否存在
  2. 调用 `trading_helper.py --action connect`
  3. 根据结果更新UI状态
  4. 连接成功后自动刷新数据

#### 1.4 断开按钮
- **控件**: `Button` (次要按钮样式)
- **文本**: "断开"
- **初始状态**: 禁用
- **功能**: 
  - 断开与券商的连接
  - 清空所有交易数据
  - 恢复初始状态

#### 1.5 刷新数据按钮
- **控件**: `Button` (次要按钮样式)
- **文本**: "刷新数据"
- **初始状态**: 禁用
- **功能**: 
  - 刷新账户信息
  - 刷新持仓列表
  - 刷新订单列表
  - 在日志中记录刷新时间

### 2. 左侧面板 - 账户与下单

#### 2.1 账户信息面板
- **标题**: "账户信息"
- **控件**: `Text` (只读文本框)
- **显示内容**:
  ```
  总资产: 1,000,000.00
  可用资金: 500,000.00
  持仓市值: 500,000.00
  冻结资金: 0.00
  ```
- **数据来源**: `trading_helper.py --action account`
- **更新时机**: 
  - 连接成功后自动刷新
  - 点击"刷新数据"时更新
  - 下单后自动刷新

#### 2.2 下单面板
- **标题**: "下单"
- **表单字段**:

  **股票代码**
  - 控件: `Entry` (输入框)
  - 默认值: "000001.XSHE"
  - 格式: JQData格式 (如 000001.XSHE, 600000.XSHG)
  - 验证: 必须填写

  **数量**
  - 控件: `Entry` (输入框)
  - 默认值: "100"
  - 验证: 必须为正整数
  - 说明: 买入为正数，卖出为负数（系统自动处理）

  **价格类型**
  - 控件: `Combobox` (下拉选择)
  - 选项: "市价", "限价"
  - 默认: "市价"

  **限价**
  - 控件: `Entry` (输入框)
  - 默认值: "0.00"
  - 说明: 仅限价单需要填写

- **操作按钮**:

  **买入按钮**
  - 样式: 主要按钮（蓝色）
  - 功能: 提交买入订单
  - 验证: 检查必填字段、连接状态
  - 执行: 调用下单接口，数量为正

  **卖出按钮**
  - 样式: 次要按钮（灰色）
  - 功能: 提交卖出订单
  - 验证: 检查必填字段、连接状态、持仓数量
  - 执行: 调用下单接口，数量为负

### 3. 右侧面板 - 持仓与订单

#### 3.1 持仓列表
- **标题**: "持仓"
- **控件**: `Treeview` (表格视图)
- **列定义**:
  | 列名 | 宽度 | 说明 | 格式 |
  |------|------|------|------|
  | 代码 | 100px | 股票代码 | JQData格式 |
  | 数量 | 80px | 持仓数量 | 整数 |
  | 成本价 | 80px | 平均成本价 | 2位小数 |
  | 当前价 | 80px | 当前市场价格 | 2位小数 |
  | 市值 | 100px | 持仓市值 | 千分位，2位小数 |

- **数据来源**: `trading_helper.py --action positions`
- **更新时机**: 同账户信息
- **交互**: 双击可快速填入下单表单

#### 3.2 订单列表
- **标题**: "订单"
- **控件**: `Treeview` (表格视图)
- **列定义**:
  | 列名 | 宽度 | 说明 | 格式 |
  |------|------|------|------|
  | 订单ID | 120px | 券商返回的订单号 | 字符串 |
  | 代码 | 100px | 股票代码 | JQData格式 |
  | 方向 | 60px | 买入/卖出 | 中文 |
  | 数量 | 80px | 委托数量 | 整数 |
  | 价格 | 80px | 委托价格 | 2位小数 |
  | 状态 | 80px | 订单状态 | 待成交/部分成交/已成交/已撤销/已拒绝 |
  | 已成交 | 80px | 已成交数量 | 整数 |

- **数据来源**: 实时查询订单状态
- **更新时机**: 
  - 下单后立即显示
  - 定时刷新（可选）
  - 手动刷新
- **交互**: 
  - 右键菜单: "撤单"
  - 仅"待成交"和"部分成交"订单可撤单
  - 双击查看订单详情

### 4. 底部日志面板

#### 4.1 交易日志
- **标题**: "交易日志"
- **控件**: `Text` (只读文本框)
- **显示内容**:
  - 连接/断开事件
  - 数据刷新事件
  - 下单/撤单操作
  - 错误信息
  - 时间戳: `[HH:MM:SS]`
- **自动滚动**: 新消息自动滚动到底部
- **字体**: Consolas 9pt (等宽字体，便于阅读)

## 交互流程

### 连接流程
```
1. 用户选择券商通道 (QMT/Ptrade)
2. 点击"连接"按钮
3. GUI显示"正在连接..."
4. 后台调用 trading_helper.py
5. 成功: 显示"已连接"(绿色) → 启用功能按钮 → 自动刷新数据
6. 失败: 显示"连接失败"(红色) → 弹出错误提示
```

### 下单流程
```
1. 用户填写股票代码、数量、价格类型
2. 点击"买入"或"卖出"
3. GUI验证必填字段
4. 调用券商下单接口
5. 在订单列表中显示新订单
6. 在日志中记录操作
7. 自动刷新账户和持仓数据
```

### 撤单流程
```
1. 用户在订单列表中右键点击订单
2. 选择"撤单"
3. 确认撤单操作
4. 调用券商撤单接口
5. 更新订单状态
6. 在日志中记录操作
```

## 技术实现

### Python环境
- **QMT**: 使用 `venv_qmt` (Python 3.12) 虚拟环境
- **Ptrade**: 使用系统Python环境（待Ptrade SDK安装后）

### 辅助脚本
- **`scripts/trading_helper.py`**: 
  - 独立的交易操作脚本
  - 供GUI通过subprocess调用
  - 返回JSON格式数据
  - 避免GUI线程阻塞

### 数据更新机制
- **同步方式**: 通过subprocess调用辅助脚本
- **异步处理**: 使用threading避免GUI冻结
- **UI更新**: 使用`self.after(0, callback)`确保线程安全

### 错误处理
- **连接超时**: 10秒超时限制
- **异常捕获**: 所有操作都有try-except
- **用户提示**: messagebox显示错误信息
- **日志记录**: 所有操作记录到日志文件

## 状态管理

### 连接状态
- `self.is_connected`: Boolean，是否已连接
- `self.connection_status`: StringVar，连接状态文本
- `self.trading_adapter`: 适配器实例（可选）

### 按钮状态联动
```
未连接:
  - 连接按钮: 启用
  - 断开按钮: 禁用
  - 刷新按钮: 禁用
  - 买入/卖出: 禁用

已连接:
  - 连接按钮: 禁用
  - 断开按钮: 启用
  - 刷新按钮: 启用
  - 买入/卖出: 启用
```

## 扩展功能（待实现）

1. **实时行情显示**: 在持仓列表中显示实时价格更新
2. **策略运行控制**: 启动/停止策略自动交易
3. **风控参数配置**: 在GUI中设置风控规则
4. **历史订单查询**: 查看历史成交记录
5. **账户曲线图**: 显示资产变化曲线
6. **告警通知**: 异常情况弹窗提醒

## 完整功能清单

### ✅ 已实现功能

1. **券商连接管理**
   - 支持QMT和Ptrade选择
   - 连接状态实时显示
   - 连接/断开控制
   - 自动环境检测（QMT使用Python 3.12虚拟环境）

2. **账户信息显示**
   - 总资产、可用资金、持仓市值、冻结资金
   - 连接成功后自动刷新
   - 手动刷新按钮

3. **持仓管理**
   - 显示代码、数量、成本价、当前价、市值
   - 双击持仓快速填入下单表单
   - 自动计算默认下单数量

4. **下单功能**
   - 支持市价单和限价单
   - 买入/卖出操作
   - 卖出前检查持仓数量
   - 价格类型切换自动启用/禁用限价输入
   - 下单成功后自动添加到订单列表
   - 下单后自动刷新账户和持仓

5. **订单管理**
   - 显示订单ID、代码、方向、数量、价格、状态、已成交
   - 右键菜单撤单
   - 双击查看订单详情
   - 仅待成交和部分成交订单可撤单

6. **交易日志**
   - 实时显示连接、下单、撤单等操作
   - 时间戳记录
   - 自动滚动到底部

### 🔄 待完善功能

1. **订单状态实时更新**
   - 当前：下单后显示在列表中，状态为"待成交"
   - 待实现：定时查询订单状态，更新已成交数量
   - 需要：QMT/Ptrade SDK提供订单查询接口

2. **实时行情显示**
   - 当前：持仓显示成本价和市值
   - 待实现：实时更新当前价格
   - 需要：QMT/Ptrade SDK提供实时行情接口

3. **历史订单查询**
   - 当前：仅显示本次会话的订单
   - 待实现：查询历史成交记录
   - 需要：SDK提供历史订单查询接口

## 使用说明

### 首次使用
1. **环境准备**
   - 确保QMT客户端已安装并登录 (`D:\国金证券QMT交易端`)
   - 确保Python 3.12虚拟环境已创建 (`venv_qmt`)
   - 确保xtquant SDK已安装到虚拟环境

2. **启动GUI**
   - 运行 `python scripts/run_taorui_manager.ps1` 或直接运行 `scripts/taorui_manager.py`
   - 打开"韬睿量化平台启动器"
   - 切换到"实盘交易"标签页

3. **连接券商**
   - 选择"QMT（国金）"或"Ptrade（国金）"
   - 点击"连接"按钮
   - 等待连接成功（状态显示"已连接"并变绿）
   - 连接成功后自动刷新账户信息和持仓

### 日常使用流程

#### 查看账户和持仓
1. 连接成功后，账户信息自动显示
2. 持仓列表显示当前所有持仓
3. 点击"刷新数据"按钮手动更新

#### 下单操作
1. **填写下单信息**
   - 股票代码：JQData格式（如 `000001.XSHE`）
   - 数量：正整数
   - 价格类型：选择"市价"或"限价"
   - 限价：仅限价单需要填写

2. **快速填入**
   - 双击持仓列表中的股票，自动填入代码和默认数量
   - 默认数量为100股或持仓的10%（取较大值）

3. **提交订单**
   - 点击"买入"或"卖出"按钮
   - 卖出时会自动检查持仓数量
   - 下单成功后订单显示在订单列表中
   - 账户和持仓自动刷新

#### 撤单操作
1. 在订单列表中找到要撤销的订单
2. 右键点击订单，选择"撤单"
3. 确认撤单操作
4. 撤单成功后订单状态更新为"已撤销"

#### 断开连接
1. 点击"断开"按钮
2. 所有交易数据清空
3. 功能按钮恢复初始状态

### 注意事项

#### 环境要求
- **QMT**: 需要QMT客户端保持运行并已登录
- **Python环境**: QMT使用`venv_qmt`虚拟环境（Python 3.12）
- **SDK**: xtquant SDK需正确安装

#### 数据格式
- **股票代码**: 必须使用JQData格式
  - 深市：`000001.XSHE`（6位代码 + .XSHE）
  - 沪市：`600000.XSHG`（6位代码 + .XSHG）
  - 科创板：`688000.XSHG`
  - 创业板：`300000.XSHE`

#### 交易规则
- **买入**: 数量必须为正整数，需要有足够可用资金
- **卖出**: 数量不能超过持仓，会自动检查
- **市价单**: 价格字段可忽略，系统自动使用市价
- **限价单**: 必须填写有效的限价（>0）

#### 错误处理
- 连接失败：检查QMT客户端是否运行，虚拟环境是否正确
- 下单失败：检查股票代码格式、数量、价格是否有效
- 撤单失败：只能撤销"待成交"和"部分成交"的订单
- 所有错误都会在日志中显示详细信息

#### 安全提示
- 账号密码存储在`config/broker_config.json`，请妥善保管
- 建议不要将配置文件提交到版本控制系统
- 实盘交易前请充分测试
- 所有操作都会记录在交易日志中

## 技术实现细节

### 数据流
```
GUI → trading_helper.py → QMTAdapter/PtradeAdapter → SDK → 券商系统
```

### 线程安全
- 所有网络操作在后台线程执行
- UI更新使用`self.after(0, callback)`确保线程安全
- 按钮状态在操作过程中自动禁用/启用

### 错误处理
- 所有subprocess调用都有超时限制（10-15秒）
- JSON解析失败时显示原始错误信息
- 异常信息完整记录到日志

### 数据格式转换
- GUI使用JQData格式（`000001.XSHE`）
- 适配器自动转换为券商格式（`000001`）
- 返回数据自动转换回JQData格式

