# 市场趋势识别模块设计文档

## 概述

市场趋势识别模块是韬睿量化系统的核心决策支持模块，位于"信息获取"之后、"投资主线"之前。

本模块综合技术分析、机器学习模型、资金流向分析等多维度手段，识别市场短期（1-8周）、中期（9-24周）和长期（25-48周）的趋势状态，并将趋势判断与策略决策紧密联动。

**参考框架：**
- IBD Market Pulse - 美国投资者商业日报的市场脉搏系统
- 贝莱德宏观分析框架 - 全球最大资产管理公司的量化模型
- 多周期技术分析理论 - 道氏理论、艾略特波浪等经典框架

## Tab页结构

### 📖 方法论
- 模块概述与定位
- 理论基础（道氏理论、均线理论、MACD、RSI、布林带）
- 多周期分析原理（周期共振、IBD Market Pulse）
- 综合评分机制

### 🏢 量化公司模型
- 头部量化公司的趋势判断工具
- Two Sigma、Renaissance Technologies、D.E. Shaw等模型介绍

### 🎤 大V观点
- 知名投资者的趋势判断方法
- 巴菲特、索罗斯、达里奥等投资大师方法论

### 📊 趋势分析
- 高级趋势仪表盘（三周期可视化）
- 市场阶段判断
- 仓位建议
- 8大技术指标详情

### 📈 技术指标
- 各指标计算公式详解
- 周期配置参数
- 评分规则说明

### 💰 资金流向 ✨ NEW
- 北向资金实时监控
- 两融余额变化
- 资金流向综合评分
- 资金异动预警

### 📉 历史图表 ✨ NEW
- K线图 + 趋势状态背景着色
- 多周期趋势可视化
- 参数可调整（指数、周期、天数）
- 图例说明

### 🧠 市场状态识别 (HMM) ✨ NEW
- 隐马尔可夫模型（HMM）分析
- 牛市/熊市/震荡三状态识别
- 状态转移概率预测
- 趋势分类器

### 🔗 策略联动
- 与投资主线联动
- 与候选池联动
- 与因子构建联动
- 与策略开发联动

## 模块架构

### 核心组件

1. **TrendAnalyzer** (`core/trend_analyzer.py`)
   - 趋势分析引擎
   - 技术指标计算（均线、MACD、RSI、布林带、成交量、KDJ、ADX、资金流）
   - 多周期趋势评分
   - 市场阶段判断

2. **TrendChartGenerator** (`core/trend_chart.py`) ✨ NEW
   - K线图表生成
   - 趋势状态背景着色
   - 多周期均线叠加
   - Base64图片输出

3. **CapitalFlowAnalyzer** (`core/capital_flow.py`) ✨ NEW
   - 北向资金数据获取（AKShare）
   - 两融余额分析
   - 资金流向综合评分
   - 资金异动检测

4. **SimpleHMM** (`core/trend_ml.py`) ✨ NEW
   - 隐马尔可夫模型
   - Viterbi算法最优路径
   - 市场隐藏状态识别
   - 状态转移概率计算

5. **TrendClassifier** (`core/trend_ml.py`) ✨ NEW
   - 规则+权重的趋势分类
   - 多特征融合
   - 置信度计算

6. **TrendAlertManager** (`core/trend_alert.py`) ✨ NEW
   - 趋势转折预警
   - 资金异动预警
   - 多周期共振预警
   - 桌面通知推送

7. **MarketTrendPanel** (`gui/widgets/market_trend_panel.py`)
   - 趋势仪表盘界面
   - 三周期趋势可视化
   - 仓位建议展示
   - 历史趋势回顾

### 在工作流程中的位置

```
信息获取 → 市场趋势 → 投资主线 → 候选池 → 因子构建 → 策略开发 → 回测验证 → 实盘交易
```

市场趋势模块位于"信息获取"之后、"投资主线"之前，为后续所有决策提供市场环境背景。

## 技术指标体系

### 1. 均线系统 (权重: 20%)
- **快速均线**: 短期5/20日，中期20/60日，长期60/250日
- **评分逻辑**:
  - 价格 > 快速均线: +25分
  - 价格 > 慢速均线: +25分
  - 均线多头排列: +30分
  - 均线斜率调整: ±20分

### 2. MACD指标 (权重: 18%)
- **参数配置**: 短期8/17/9，中期12/26/9，长期26/52/9
- **评分逻辑**:
  - 柱状图为正: +30分
  - 柱状图增加: +20分
  - MACD金叉: +25分
  - 零轴上方: +25分

### 3. RSI指标 (权重: 12%)
- **参数配置**: 短期6日，中期14日，长期21日
- **评分逻辑**:
  - RSI > 50: +30分
  - RSI趋势向上: +20分
  - 超买/超卖极端值调整

### 4. 布林带 (权重: 12%)
- **参数**: 20日均线，2倍标准差
- **评分逻辑**:
  - 价格在上轨: +40分
  - 价格在中轨上方: +20分
  - 带宽扩大: +10分

### 5. 成交量趋势 (权重: 12%)
- **评分逻辑**:
  - 放量上涨: +40分
  - 缩量上涨: +10分
  - 放量下跌: -40分
  - 量能趋势向上: +20分

### 6. KDJ指标 (权重: 10%) ✨ NEW
- **参数**: 9日周期
- **评分逻辑**:
  - K > D 且趋势向上: +40分
  - J值金叉/死叉信号
  - 超买超卖调整

### 7. ADX指标 (权重: 8%) ✨ NEW
- **参数**: 14日周期
- **评分逻辑**:
  - ADX > 25表示趋势强烈
  - +DI > -DI表示上涨趋势

### 8. 资金流指标 (权重: 8%) ✨ NEW
- **OBV**: 能量潮指标
- **MFI**: 资金流量指标
- **评分逻辑**:
  - OBV趋势向上: +30分
  - MFI > 50: +30分

## 机器学习模型

### 隐马尔可夫模型 (HMM)

**隐藏状态:**
- 🟢 **牛市状态**: 收益率为正、成交量放大、波动率适中
- 🔴 **熊市状态**: 收益率为负、恐慌性放量、波动率升高
- 🟡 **震荡状态**: 收益率接近零、成交量萎缩、波动率较低

**观测变量:**
1. 每日收益率变化
2. 成交量变化率
3. 波动率水平

**算法:** Viterbi算法找最可能的状态序列

**状态转移矩阵 (经验值):**
```
        Bull    Bear    Sideways
Bull    0.85    0.05    0.10
Bear    0.05    0.80    0.15
Side    0.20    0.20    0.60
```

### 趋势分类器

**特征权重:**
- ma_cross: 20%
- macd_signal: 18%
- rsi_level: 12%
- price_position: 15%
- volume_trend: 12%
- volatility: 10%
- momentum: 13%

## 资金流向分析

### 北向资金监控
- **数据源**: AKShare (免费)
- **指标**:
  - 今日净流入
  - 5日累计净流入
  - 沪股通/深股通分项

### 两融余额
- **指标**:
  - 融资余额
  - 融资余额变化

### 资金流向评分
- **评分范围**: -100 到 +100
- **评分逻辑**:
  - 大额流入 (+50亿以上): +30分
  - 中额流入 (+20~50亿): +20分
  - 小额流入 (+0~20亿): +10分
  - 小额流出 (-20~0亿): -10分
  - 中额流出 (-50~-20亿): -20分
  - 大额流出 (-50亿以下): -30分

## 历史趋势图表

### 图表特性
- **K线图**: 开盘、收盘、最高、最低
- **均线叠加**: 快速/慢速均线
- **成交量柱**: 红涨绿跌
- **MACD副图**: 柱状图 + DIF/DEA

### 趋势背景着色
| 分数范围 | 状态 | 颜色 |
|----------|------|------|
| > +60 | 强势上涨 | 深绿色透明 |
| +30 ~ +60 | 上涨趋势 | 浅绿色透明 |
| 0 ~ +30 | 弱势上涨 | 淡绿色透明 |
| -30 ~ 0 | 弱势下跌 | 黄色透明 |
| -60 ~ -30 | 下跌趋势 | 橙色透明 |
| < -60 | 强势下跌 | 红色透明 |

## 趋势预警系统

### 预警类型
1. **趋势转折**: 综合得分大幅变化 (阈值: 30分)
2. **市场阶段变化**: 如牛市转熊市
3. **多周期共振**: 三周期同向看多/看空
4. **资金异动**: 北向资金大额流入/流出 (阈值: 50亿)

### 预警级别
- **INFO**: 一般信息
- **WARNING**: 警告级别
- **CRITICAL**: 严重预警

### 通知方式
- GUI内预警列表
- 桌面通知 (Linux notify-send)
- 日志记录

## 多周期支持

### 周期配置

| 周期 | 时长 | 分析天数 | 权重 |
|------|------|----------|------|
| 短期 | 1-8周 | 40日 | 20% |
| 中期 | 9-24周 | 120日 | 30% |
| 长期 | 25-48周 | 240日 | 50% |

### 周期共振规则

- **长中短同向**: 高置信度信号
- **长期为主**: 长周期信号优先于短周期
- **短期触发**: 短期信号用于精细化进出场

## 策略建议输出

### 仓位建议

| 综合得分 | 建议仓位 | 策略方向 | 推荐因子 |
|----------|----------|----------|----------|
| +60以上 | 80-100% | 积极进攻 | 动量、成长、资金流 |
| +30~+60 | 50-80% | 稳健持仓 | 动量、质量、成长 |
| 0~+30 | 30-50% | 谨慎操作 | 质量、价值、低波动 |
| -30~0 | 10-30% | 防御为主 | 价值、低波动、股息 |
| -30以下 | 0-10% | 空仓观望 | 现金为王 |

## 模块联动

### 与投资主线联动
- 市场趋势向好时，主线热点更有效
- 趋势下行时，即使有主线也需谨慎

### 与候选池联动
- 上行趋势：筛选强势股、高贝塔股
- 下行趋势：筛选防御股、低波动股

### 与因子构建联动
- 根据趋势动态调整因子权重
- 牛市：提高动量、成长因子权重
- 熊市：提高价值、低波动因子权重

### 与策略开发联动
- 趋势作为交易方向开关
- 趋势强弱决定仓位水平

## 数据缓存

结果自动保存到MongoDB `jqquant.market_trend_cache`：
- 缓存有效期：1小时
- 自动加载上次分析结果

## 功能实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 8大技术指标体系 | ✅ 完成 | MA, MACD, RSI, 布林带, 成交量, KDJ, ADX, MFI |
| 多周期趋势分析 | ✅ 完成 | 短期/中期/长期 |
| 综合评分机制 | ✅ 完成 | -100到+100 |
| 趋势仪表盘可视化 | ✅ 完成 | 3个Gauge组件 |
| 仓位建议和因子风格建议 | ✅ 完成 | 动态计算 |
| 多周期共振逻辑 | ✅ 完成 | 共振强度/方向一致性 |
| 8指标详情展示 | ✅ 完成 | 卡片式展示 |
| 北向资金实时数据 | ✅ 完成 | AKShare数据源 |
| 两融数据 | ✅ 完成 | AKShare数据源 |
| 资金流向评分 | ✅ 完成 | -100到+100 |
| 历史趋势图表 | ✅ 完成 | K线+背景着色 |
| 参数调整交互 | ✅ 完成 | 指数/周期/天数 |
| HMM市场状态识别 | ✅ 完成 | 简化版HMM |
| 趋势分类器 | ✅ 完成 | 规则+权重 |
| 趋势预警通知 | ✅ 完成 | 多类型预警 |
| 情绪指标融合 | 🔄 进行中 | 待接入更多数据源 |
| 回测验证模块 | 📋 计划中 | 与策略模块联动 |

## 参考资料

- IBD Market Pulse 方法论
- 贝莱德宏观分析框架
- 多周期技术分析理论
- 隐马尔可夫模型 (HMM) 教程

## 使用示例

```python
# 趋势分析
from core.trend_analyzer import create_trend_analyzer
analyzer = create_trend_analyzer(jq_client)
result = analyzer.analyze_market("000001.XSHG")

# 资金流向分析
from core.capital_flow import create_capital_flow_analyzer
flow_analyzer = create_capital_flow_analyzer()
flow_result = flow_analyzer.analyze_capital_flow()

# HMM状态识别
from core.trend_ml import create_hmm_analyzer
hmm = create_hmm_analyzer()
hmm_result = hmm.analyze(price_df)

# 趋势图表
from core.trend_chart import create_trend_chart_generator
generator = create_trend_chart_generator(jq_client)
chart_base64 = generator.generate_trend_chart("000001.XSHG", days=120)

# 趋势预警
from core.trend_alert import create_alert_manager
alert_mgr = create_alert_manager()
alerts = alert_mgr.check_trend_change(current_result, previous_result)
```
