# -*- coding: utf-8 -*-
"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()






"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()




"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()

"""
PTrade Bridge - FastAPI REST API
提供 Cursor 和仪表盘调用的接口
"""
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Dict, Optional, Any
from datetime import datetime
import logging

from .models import Strategy, StrategyStatus, BacktestResult, Trade
from .service import PTradeBridgeService, PTradeBridgeConfig

logger = logging.getLogger(__name__)


# ==================== Pydantic Models ====================

class StrategyCreate(BaseModel):
    """创建策略请求"""
    id: str
    name: str
    version: str = "v1.0.0"
    description: str = ""
    code_path: str = ""
    parameters: Dict[str, Any] = {}


class StrategyUpdate(BaseModel):
    """更新策略请求"""
    name: Optional[str] = None
    version: Optional[str] = None
    description: Optional[str] = None
    status: Optional[str] = None
    parameters: Optional[Dict[str, Any]] = None


class DeployRequest(BaseModel):
    """部署请求"""
    strategy_id: str


class ApiResponse(BaseModel):
    """通用响应"""
    success: bool
    message: str = ""
    data: Optional[Any] = None


# ==================== 创建应用 ====================

def create_app(config: PTradeBridgeConfig = None) -> FastAPI:
    """创建 FastAPI 应用"""
    
    app = FastAPI(
        title="PTrade Bridge API",
        description="韬睿量化 - PTrade 桥接服务 API",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc",
    )
    
    # CORS 配置
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 初始化服务
    service = PTradeBridgeService(config)
    
    # 启动时开始文件监听
    @app.on_event("startup")
    async def startup():
        service.start_watching()
        logger.info("PTrade Bridge API 已启动")
    
    @app.on_event("shutdown")
    async def shutdown():
        service.stop_watching()
        logger.info("PTrade Bridge API 已停止")
    
    # ==================== 健康检查 ====================
    
    @app.get("/", tags=["健康检查"])
    async def root():
        """API 根路径"""
        return {
            "service": "PTrade Bridge",
            "version": "1.0.0",
            "status": "running",
            "timestamp": datetime.now().isoformat(),
        }
    
    @app.get("/health", tags=["健康检查"])
    async def health():
        """健康检查"""
        return {
            "status": "healthy",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    # ==================== 策略管理 ====================
    
    @app.get("/strategies", tags=["策略管理"])
    async def list_strategies():
        """获取所有策略"""
        strategies = service.get_strategies()
        return {
            "success": True,
            "data": [s.to_dict() for s in strategies],
            "total": len(strategies),
        }
    
    @app.get("/strategies/{strategy_id}", tags=["策略管理"])
    async def get_strategy(strategy_id: str):
        """获取单个策略"""
        strategy = service.get_strategy(strategy_id)
        if not strategy:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        # 获取最新回测结果
        latest_backtest = service.get_latest_backtest(strategy_id)
        
        return {
            "success": True,
            "data": {
                **strategy.to_dict(),
                "latest_backtest": latest_backtest.to_dict() if latest_backtest else None,
            }
        }
    
    @app.post("/strategies", tags=["策略管理"])
    async def create_strategy(request: StrategyCreate):
        """创建策略"""
        strategy = Strategy(
            id=request.id,
            name=request.name,
            version=request.version,
            description=request.description,
            code_path=request.code_path,
            parameters=request.parameters,
        )
        
        created = service.create_strategy(strategy)
        return {
            "success": True,
            "message": "策略创建成功",
            "data": created.to_dict(),
        }
    
    @app.put("/strategies/{strategy_id}", tags=["策略管理"])
    async def update_strategy(strategy_id: str, request: StrategyUpdate):
        """更新策略"""
        updates = {k: v for k, v in request.dict().items() if v is not None}
        
        if 'status' in updates:
            updates['status'] = StrategyStatus(updates['status'])
        
        updated = service.update_strategy(strategy_id, updates)
        if not updated:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略更新成功",
            "data": updated.to_dict(),
        }
    
    @app.delete("/strategies/{strategy_id}", tags=["策略管理"])
    async def delete_strategy(strategy_id: str):
        """删除策略"""
        success = service.delete_strategy(strategy_id)
        if not success:
            raise HTTPException(status_code=404, detail="策略不存在")
        
        return {
            "success": True,
            "message": "策略删除成功",
        }
    
    @app.post("/strategies/deploy", tags=["策略管理"])
    async def deploy_strategy(request: DeployRequest):
        """部署策略到 PTrade"""
        result = service.deploy_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    @app.post("/strategies/stop", tags=["策略管理"])
    async def stop_strategy(request: DeployRequest):
        """停止策略"""
        result = service.stop_strategy(request.strategy_id)
        
        if not result["success"]:
            raise HTTPException(status_code=400, detail=result["message"])
        
        return result
    
    # ==================== 回测结果 ====================
    
    @app.get("/backtests", tags=["回测结果"])
    async def list_backtests(strategy_id: Optional[str] = Query(None)):
        """获取回测结果列表"""
        backtests = service.get_backtests(strategy_id)
        return {
            "success": True,
            "data": [bt.to_dict() for bt in backtests],
            "total": len(backtests),
        }
    
    @app.get("/backtests/{backtest_id}", tags=["回测结果"])
    async def get_backtest(backtest_id: str):
        """获取单个回测结果"""
        backtest = service.get_backtest(backtest_id)
        if not backtest:
            raise HTTPException(status_code=404, detail="回测结果不存在")
        
        return {
            "success": True,
            "data": backtest.to_dict(),
        }
    
    # ==================== 交易记录 ====================
    
    @app.get("/trades", tags=["交易记录"])
    async def list_trades(
        strategy_id: Optional[str] = Query(None),
        limit: int = Query(100, ge=1, le=1000)
    ):
        """获取交易记录"""
        trades = service.get_trades(strategy_id, limit)
        return {
            "success": True,
            "data": [t.to_dict() for t in trades],
            "total": len(trades),
        }
    
    # ==================== 数据刷新 ====================
    
    @app.post("/refresh", tags=["系统"])
    async def refresh_data():
        """刷新所有数据"""
        service.refresh()
        return {
            "success": True,
            "message": "数据已刷新",
            "strategies_count": len(service.get_strategies()),
            "backtests_count": len(service.get_backtests()),
        }
    
    return app


# 默认应用实例
app = create_app()














