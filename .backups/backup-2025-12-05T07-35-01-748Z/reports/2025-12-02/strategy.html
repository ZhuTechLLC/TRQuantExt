<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>ç­–ç•¥ç”Ÿæˆ - éŸ¬ç¿é‡åŒ–</title>
<style>body{font-family:'Microsoft YaHei';background:#1a1a2e;color:#e0e0e0;padding:40px;}
.header{background:linear-gradient(135deg,#667eea,#764ba2);padding:24px;border-radius:12px;margin-bottom:20px;}
h1{margin:0;font-size:24px;}pre{background:#2a2a4a;padding:16px;border-radius:8px;overflow-x:auto;}
</style></head><body>
<div class="header"><h1>ç­–ç•¥ç”Ÿæˆ</h1><p>2025-12-02T00:46:49.329612</p></div>
<h2>æ‘˜è¦</h2><p>ğŸ’» PTradeç­–ç•¥å·²ç”Ÿæˆ: strategy_20251202_004649.py</p>
<h2>è¯¦ç»†æ•°æ®</h2><pre>{
  "strategy_code": "# -*- coding: utf-8 -*-\n\"\"\"\néŸ¬ç¿é‡åŒ– - å¤šå› å­é€‰è‚¡ç­–ç•¥\n========================\nè‡ªåŠ¨ç”Ÿæˆæ—¶é—´: 2025-12-02 00:46:49\nå¸‚åœºç¯å¢ƒ: ç‰›å¸‚\nè°ƒä»“é¢‘ç‡: 5ä¸ªäº¤æ˜“æ—¥\næŒä»“æ•°é‡: 20åª\nä¸»çº¿é¢˜æ: [\"å¤ªèµ«å…¹\", \"æµ·å³¡ä¸¤å²¸\", \"å†›å·¥ä¿¡æ¯åŒ–\"]\n\nç­–ç•¥è¯´æ˜ï¼š\næœ¬ç­–ç•¥åŸºäºéŸ¬ç¿é‡åŒ–ç³»ç»Ÿçš„å¸‚åœºè¶‹åŠ¿åˆ†æã€æŠ•èµ„ä¸»çº¿è¯†åˆ«ã€å› å­ç»„åˆæ¨è\nè‡ªåŠ¨ç”Ÿæˆã€‚ç­–ç•¥é‡‡ç”¨å¤šå› å­æ‰“åˆ†æ–¹æ³•ï¼Œç»¼åˆè€ƒè™‘åŠ¨é‡ã€ä»·å€¼ã€æˆé•¿ã€è´¨é‡\nç­‰å› å­ï¼Œé€‰å–ç»¼åˆå¾—åˆ†æœ€é«˜çš„è‚¡ç¥¨æ„å»ºæŠ•èµ„ç»„åˆã€‚\n\"\"\"\n\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime, timedelta\n\ndef init(context):\n    \"\"\"åˆå§‹åŒ–ç­–ç•¥\"\"\"\n    # è®¾ç½®åŸºå‡†\n    set_benchmark('000300.SH')\n    \n    # è®¾ç½®äº¤æ˜“å‚æ•°\n    set_slippage(PriceRelatedSlippage(0.002))\n    set_commission(PerTrade(buy_cost=0.0003, sell_cost=0.0013, min_cost=5))\n    \n    # ç­–ç•¥å‚æ•°\n    context.rebalance_days = 5  # è°ƒä»“å‘¨æœŸ\n    context.day_count = 0\n    context.max_stocks = 20  # æœ€å¤§æŒä»“æ•°\n    \n    # å› å­æƒé‡ï¼ˆåŸºäºå¸‚åœºç¯å¢ƒ: ç‰›å¸‚ï¼‰\n    context.factor_weights = {\n        \"momentum\": 0.35,\n        \"growth\": 0.3,\n        \"quality\": 0.2,\n        \"size\": 0.15\n}\n    \n    # ä¸»çº¿é¢˜æï¼ˆç”¨äºç­›é€‰è‚¡ç¥¨æ± ï¼‰\n    context.mainlines = [\"å¤ªèµ«å…¹\", \"æµ·å³¡ä¸¤å²¸\", \"å†›å·¥ä¿¡æ¯åŒ–\"]\n    \n    # é£æ§å‚æ•°\n    context.stop_loss = 0.08  # æ­¢æŸæ¯”ä¾‹\n    context.take_profit = 0.20  # æ­¢ç›ˆæ¯”ä¾‹\n    \n    log.info(\"ç­–ç•¥åˆå§‹åŒ–å®Œæˆ\")\n    log.info(f\"è°ƒä»“å‘¨æœŸ: {context.rebalance_days}å¤©\")\n    log.info(f\"å› å­æƒé‡: {context.factor_weights}\")\n\ndef before_trading(context):\n    \"\"\"ç›˜å‰å¤„ç†\"\"\"\n    context.day_count += 1\n\ndef handle_bar(context, bar_dict):\n    \"\"\"æ¯æ—¥äº¤æ˜“é€»è¾‘\"\"\"\n    # æ£€æŸ¥æ˜¯å¦è°ƒä»“æ—¥\n    if context.day_count % context.rebalance_days != 0:\n        # éè°ƒä»“æ—¥åªåšé£æ§\n        check_risk_control(context, bar_dict)\n        return\n    \n    log.info(f\"=== ç¬¬{context.day_count}å¤©ï¼Œå¼€å§‹è°ƒä»“ ===\")\n    \n    # è·å–å€™é€‰è‚¡ç¥¨æ± \n    stocks = get_candidate_pool(context)\n    if not stocks:\n        log.warn(\"å€™é€‰æ± ä¸ºç©ºï¼Œè·³è¿‡è°ƒä»“\")\n        return\n    \n    log.info(f\"å€™é€‰æ± è‚¡ç¥¨æ•°: {len(stocks)}\")\n    \n    # è®¡ç®—å› å­å¾—åˆ†\n    scores = calculate_factor_scores(context, stocks, bar_dict)\n    if scores.empty:\n        log.warn(\"å› å­è®¡ç®—å¤±è´¥ï¼Œè·³è¿‡è°ƒä»“\")\n        return\n    \n    # é€‰å–Top Nè‚¡ç¥¨\n    selected = scores.nlargest(context.max_stocks, 'composite_score')\n    target_stocks = selected.index.tolist()\n    \n    log.info(f\"é€‰ä¸­è‚¡ç¥¨: {len(target_stocks)}åª\")\n    \n    # è°ƒæ•´ä»“ä½\n    rebalance_portfolio(context, target_stocks, bar_dict)\n\ndef get_candidate_pool(context):\n    \"\"\"è·å–å€™é€‰è‚¡ç¥¨æ± \"\"\"\n    # è·å–æ²ªæ·±300æˆåˆ†è‚¡ä½œä¸ºåŸºç¡€æ± \n    stocks = get_index_stocks('000300.SH')\n    \n    # è¿‡æ»¤STå’Œåœç‰Œè‚¡ç¥¨\n    stocks = filter_stocks(stocks)\n    \n    return stocks\n\ndef filter_stocks(stocks):\n    \"\"\"è¿‡æ»¤è‚¡ç¥¨\"\"\"\n    filtered = []\n    for stock in stocks:\n        # è¿‡æ»¤ST\n        info = get_security_info(stock)\n        if info and 'ST' not in info.display_name:\n            # è¿‡æ»¤åœç‰Œ\n            if is_trading(stock):\n                filtered.append(stock)\n    return filtered\n\ndef calculate_factor_scores(context, stocks, bar_dict):\n    \"\"\"è®¡ç®—å› å­ç»¼åˆå¾—åˆ†\"\"\"\n    scores = pd.DataFrame(index=stocks)\n    weights = context.factor_weights\n    \n    try:\n        # åŠ¨é‡å› å­ï¼ˆ20æ—¥æ¶¨å¹…ï¼‰\n        if 'momentum' in weights:\n            momentum = get_price_change(stocks, 20)\n            scores['momentum'] = zscore(momentum)\n        \n        # ä»·å€¼å› å­ï¼ˆEP: å‡€åˆ©æ¶¦/å¸‚å€¼ï¼‰\n        if 'value' in weights:\n            ep = get_fundamentals(query(\n                valuation.pe_ratio\n            ).filter(\n                valuation.code.in_(stocks)\n            ))\n            if not ep.empty:\n                scores['value'] = zscore(1 / ep['pe_ratio'])\n        \n        # æˆé•¿å› å­ï¼ˆè¥æ”¶å¢é•¿ç‡ï¼‰\n        if 'growth' in weights:\n            growth = get_fundamentals(query(\n                indicator.inc_revenue_year_on_year\n            ).filter(\n                indicator.code.in_(stocks)\n            ))\n            if not growth.empty:\n                scores['growth'] = zscore(growth['inc_revenue_year_on_year'])\n        \n        # è´¨é‡å› å­ï¼ˆROEï¼‰\n        if 'quality' in weights:\n            roe = get_fundamentals(query(\n                indicator.roe\n            ).filter(\n                indicator.code.in_(stocks)\n            ))\n            if not roe.empty:\n                scores['quality'] = zscore(roe['roe'])\n        \n        # è§„æ¨¡å› å­ï¼ˆå¸‚å€¼ï¼Œå–è´Ÿè¡¨ç¤ºåå¥½å°ç›˜ï¼‰\n        if 'size' in weights:\n            cap = get_fundamentals(query(\n                valuation.market_cap\n            ).filter(\n                valuation.code.in_(stocks)\n            ))\n            if not cap.empty:\n                scores['size'] = zscore(-cap['market_cap'])\n        \n        # å¡«å……ç¼ºå¤±å€¼\n        scores = scores.fillna(0)\n        \n        # è®¡ç®—ç»¼åˆå¾—åˆ†\n        scores['composite_score'] = 0\n        for factor, weight in weights.items():\n            if factor in scores.columns:\n                scores['composite_score'] += scores[factor] * weight\n        \n    except Exception as e:\n        log.error(f\"å› å­è®¡ç®—é”™è¯¯: {e}\")\n        return pd.DataFrame()\n    \n    return scores\n\ndef zscore(series):\n    \"\"\"Z-scoreæ ‡å‡†åŒ–\"\"\"\n    mean = series.mean()\n    std = series.std()\n    if std == 0:\n        return series * 0\n    return (series - mean) / std\n\ndef get_price_change(stocks, days):\n    \"\"\"è·å–ä»·æ ¼å˜åŠ¨\"\"\"\n    changes = {}\n    for stock in stocks:\n        try:\n            prices = history(stock, ['close'], days + 1, '1d')\n            if len(prices) > days:\n                changes[stock] = (prices.iloc[-1]['close'] - prices.iloc[0]['close']) / prices.iloc[0]['close']\n        except:\n            changes[stock] = 0\n    return pd.Series(changes)\n\ndef rebalance_portfolio(context, target_stocks, bar_dict):\n    \"\"\"è°ƒæ•´æŠ•èµ„ç»„åˆ\"\"\"\n    current_positions = set(context.portfolio.positions.keys())\n    target_set = set(target_stocks)\n    \n    # å–å‡ºä¸åœ¨ç›®æ ‡ä¸­çš„è‚¡ç¥¨\n    for stock in current_positions - target_set:\n        order_target_percent(stock, 0)\n        log.info(f\"å–å‡º: {stock}\")\n    \n    # ç­‰æƒä¹°å…¥ç›®æ ‡è‚¡ç¥¨\n    if target_stocks:\n        weight = 0.95 / len(target_stocks)  # ç•™5%ç°é‡‘\n        for stock in target_stocks:\n            order_target_percent(stock, weight)\n            log.info(f\"ä¹°å…¥: {stock}, æƒé‡: {weight:.2%}\")\n\ndef check_risk_control(context, bar_dict):\n    \"\"\"é£é™©æ§åˆ¶æ£€æŸ¥\"\"\"\n    for stock, position in context.portfolio.positions.items():\n        if position.quantity <= 0:\n            continue\n        \n        current_price = bar_dict[stock].close\n        avg_cost = position.avg_cost\n        \n        # è®¡ç®—æ”¶ç›Šç‡\n        pnl_ratio = (current_price - avg_cost) / avg_cost\n        \n        # æ­¢æŸ\n        if pnl_ratio < -context.stop_loss:\n            order_target_percent(stock, 0)\n            log.warn(f\"æ­¢æŸå–å‡º: {stock}, äºæŸ: {pnl_ratio:.2%}\")\n        \n        # æ­¢ç›ˆ\n        elif pnl_ratio > context.take_profit:\n            order_target_percent(stock, 0)\n            log.info(f\"æ­¢ç›ˆå–å‡º: {stock}, ç›ˆåˆ©: {pnl_ratio:.2%}\")\n\ndef is_trading(stock):\n    \"\"\"æ£€æŸ¥æ˜¯å¦å¯äº¤æ˜“\"\"\"\n    try:\n        current_data = get_current_data()\n        return not current_data[stock].paused\n    except:\n        return True\n",
  "strategy_file": "/home/taotao/dev/QuantTest/TRQuant/strategies/ptrade/strategy_20251202_004649.py",
  "strategy_type": "å¤šå› å­é€‰è‚¡",
  "market_env": "ç‰›å¸‚",
  "rebalance_freq": "å‘¨åº¦",
  "stock_count": 20,
  "factors": [
    {
      "name": "åŠ¨é‡å› å­",
      "weight": 0.35,
      "reason": "ç‰›å¸‚è¿½æ¶¨æ•ˆåº”æ˜æ˜¾"
    },
    {
      "name": "æˆé•¿å› å­",
      "weight": 0.3,
      "reason": "å¸‚åœºåå¥½é«˜æˆé•¿è‚¡"
    },
    {
      "name": "è´¨é‡å› å­",
      "weight": 0.2,
      "reason": "æ§åˆ¶å›æ’¤é£é™©"
    },
    {
      "name": "è§„æ¨¡å› å­",
      "weight": 0.15,
      "reason": "å°ç›˜è‚¡å¼¹æ€§æ›´å¤§"
    }
  ]
}</pre>
</body></html>