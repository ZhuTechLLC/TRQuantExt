#!/usr/bin/env bash
# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†è„šæœ¬
# ç»Ÿä¸€ç®¡ç†GUIã€Dashboardã€BridgeæœåŠ¡çš„Dockeréƒ¨ç½²
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
cd "${PROJECT_ROOT}"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# é…ç½®
COMPOSE_FILE="docker-compose.gui.yml"
IMAGE_NAME="jqquant/professional:latest"

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - Dockerç®¡ç†å·¥å…·                  â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_help() {
    echo -e "${GREEN}ç”¨æ³•:${NC} $0 <å‘½ä»¤> [é€‰é¡¹]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  build           æ„å»ºDockeré•œåƒ"
    echo "  gui             å¯åŠ¨GUIåº”ç”¨ï¼ˆéœ€è¦X11ï¼‰"
    echo "  dashboard       å¯åŠ¨Dashboard WebæœåŠ¡"
    echo "  services        å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡ï¼ˆDashboard + Bridgesï¼‰"
    echo "  all             å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¸å«GUIï¼‰"
    echo "  stop            åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart         é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  logs [service]  æŸ¥çœ‹æ—¥å¿—"
    echo "  status          æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
    echo "  clean           æ¸…ç†Dockerèµ„æº"
    echo "  shell           è¿›å…¥å®¹å™¨Shell"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 build              # æ„å»ºé•œåƒ"
    echo "  $0 gui                # å¯åŠ¨GUI"
    echo "  $0 services           # å¯åŠ¨åå°æœåŠ¡"
    echo "  $0 logs dashboard     # æŸ¥çœ‹Dashboardæ—¥å¿—"
}

check_docker() {
    if ! command -v docker &>/dev/null; then
        echo -e "${RED}âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker${NC}"
        exit 1
    fi
    if ! docker info &>/dev/null; then
        echo -e "${RED}âŒ DockeræœåŠ¡æœªè¿è¡Œæˆ–æƒé™ä¸è¶³${NC}"
        exit 1
    fi
}

setup_x11() {
    if [[ -n "${DISPLAY:-}" ]] && command -v xhost &>/dev/null; then
        xhost +local:docker &>/dev/null || true
        echo -e "${GREEN}âœ“ X11è®¿é—®å·²é…ç½®${NC}"
    fi
}

cmd_build() {
    echo -e "${BLUE}ğŸ”¨ æ„å»ºDockeré•œåƒ...${NC}"
    docker build -t "${IMAGE_NAME}" -f Dockerfile.gui .
    echo -e "${GREEN}âœ“ é•œåƒæ„å»ºå®Œæˆ: ${IMAGE_NAME}${NC}"
}

cmd_gui() {
    setup_x11
    echo -e "${BLUE}ğŸš€ å¯åŠ¨GUIåº”ç”¨...${NC}"
    
    # ç¡®ä¿é•œåƒå­˜åœ¨
    if ! docker image inspect "${IMAGE_NAME}" &>/dev/null; then
        echo -e "${YELLOW}é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹æ„å»º...${NC}"
        cmd_build
    fi
    
    docker run --rm \
        --name jqquant-gui \
        -e DISPLAY="${DISPLAY:-:0}" \
        -e QT_X11_NO_MITSHM=1 \
        -e XAUTHORITY=/root/.Xauthority \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v "${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:ro" \
        -v "${PROJECT_ROOT}/config:/app/config" \
        -v "${PROJECT_ROOT}/data:/app/data" \
        -v "${PROJECT_ROOT}/logs:/app/logs" \
        -v "${PROJECT_ROOT}/results:/app/results" \
        -v "${PROJECT_ROOT}/strategies:/app/strategies" \
        -v "${PROJECT_ROOT}/investment-manual:/app/investment-manual:ro" \
        --device /dev/dri:/dev/dri \
        --ipc=host \
        "${IMAGE_NAME}" \
        python3 JQQuant.py
}

cmd_dashboard() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨DashboardæœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d dashboard
    echo -e "${GREEN}âœ“ Dashboardå·²å¯åŠ¨: http://localhost:5000${NC}"
}

cmd_services() {
    echo -e "${BLUE}ğŸ”§ å¯åŠ¨æ‰€æœ‰åå°æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile services up -d
    echo -e "${GREEN}âœ“ æœåŠ¡å·²å¯åŠ¨:${NC}"
    echo "  - Dashboard:          http://localhost:5000"
    echo "  - PTrade Bridge:      http://localhost:8001"
    echo "  - QMT Bridge:         http://localhost:8002"
    echo "  - QuantConnect Bridge: http://localhost:8003"
}

cmd_all() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all up -d
    echo -e "${GREEN}âœ“ æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨${NC}"
}

cmd_stop() {
    echo -e "${YELLOW}â¹ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"
    docker compose -f "${COMPOSE_FILE}" --profile all down
    docker stop jqquant-gui 2>/dev/null || true
    echo -e "${GREEN}âœ“ æœåŠ¡å·²åœæ­¢${NC}"
}

cmd_restart() {
    cmd_stop
    sleep 2
    cmd_services
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "${service}" ]]; then
        docker compose -f "${COMPOSE_FILE}" logs -f "${service}"
    else
        docker compose -f "${COMPOSE_FILE}" logs -f
    fi
}

cmd_status() {
    echo -e "${BLUE}ğŸ“Š æœåŠ¡çŠ¶æ€:${NC}"
    docker compose -f "${COMPOSE_FILE}" ps
    echo ""
    echo -e "${BLUE}ğŸ“¦ å®¹å™¨çŠ¶æ€:${NC}"
    docker ps --filter "name=jqquant" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
}

cmd_clean() {
    echo -e "${YELLOW}ğŸ§¹ æ¸…ç†Dockerèµ„æº...${NC}"
    docker compose -f "${COMPOSE_FILE}" down -v --remove-orphans
    docker image prune -f
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

cmd_shell() {
    local container="${1:-jqquant-dashboard}"
    echo -e "${BLUE}ğŸš è¿›å…¥å®¹å™¨ ${container}...${NC}"
    docker exec -it "${container}" /bin/bash
}

# ä¸»å…¥å£
print_banner
check_docker

case "${1:-help}" in
    build)      cmd_build ;;
    gui)        cmd_gui ;;
    dashboard)  cmd_dashboard ;;
    services)   cmd_services ;;
    all)        cmd_all ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "${2:-}" ;;
    status)     cmd_status ;;
    clean)      cmd_clean ;;
    shell)      cmd_shell "${2:-}" ;;
    help|--help|-h)
        print_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        print_help
        exit 1
        ;;
esac














