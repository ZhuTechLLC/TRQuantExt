#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()






# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()




# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()

# -*- coding: utf-8 -*-
"""
PTrade Bridge CLI 工具
在 Cursor 中使用的命令行工具

用法:
    python scripts/ptrade_cli.py strategies          # 列出所有策略
    python scripts/ptrade_cli.py strategy <id>       # 查看策略详情
    python scripts/ptrade_cli.py backtests [--strategy <id>]  # 列出回测结果
    python scripts/ptrade_cli.py backtest <id>       # 查看回测详情
    python scripts/ptrade_cli.py trades [--strategy <id>]     # 列出交易记录
    python scripts/ptrade_cli.py deploy <strategy_id>         # 部署策略
    python scripts/ptrade_cli.py refresh             # 刷新数据
    python scripts/ptrade_cli.py prompt <type>       # 生成 Prompt
"""
import sys
import os
import argparse
import json
import requests
from pathlib import Path
from datetime import datetime
from typing import Optional

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

# API 配置
API_BASE_URL = os.environ.get("PTRADE_BRIDGE_URL", "http://127.0.0.1:8000")


class Colors:
    """终端颜色"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'


def print_header(text: str):
    """打印标题"""
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}  {text}{Colors.END}")
    print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.END}\n")


def print_success(text: str):
    print(f"{Colors.GREEN}✓ {text}{Colors.END}")


def print_error(text: str):
    print(f"{Colors.RED}✗ {text}{Colors.END}")


def print_info(text: str):
    print(f"{Colors.BLUE}ℹ {text}{Colors.END}")


def print_warning(text: str):
    print(f"{Colors.YELLOW}⚠ {text}{Colors.END}")


def api_get(endpoint: str) -> dict:
    """GET 请求"""
    try:
        response = requests.get(f"{API_BASE_URL}{endpoint}", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        print_info("请先启动服务: python -m ptrade_bridge.server")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


def api_post(endpoint: str, data: dict = None) -> dict:
    """POST 请求"""
    try:
        response = requests.post(f"{API_BASE_URL}{endpoint}", json=data or {}, timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.ConnectionError:
        print_error(f"无法连接到 PTrade Bridge 服务 ({API_BASE_URL})")
        sys.exit(1)
    except Exception as e:
        print_error(f"请求失败: {e}")
        sys.exit(1)


# ==================== 命令实现 ====================

def cmd_strategies(args):
    """列出所有策略"""
    print_header("策略列表")
    
    result = api_get("/strategies")
    strategies = result.get("data", [])
    
    if not strategies:
        print_warning("暂无策略")
        return
    
    # 表格格式输出
    print(f"{'ID':<20} {'名称':<20} {'版本':<10} {'状态':<10} {'更新时间':<20}")
    print("-" * 80)
    
    for s in strategies:
        status = s.get('status', 'draft')
        status_color = {
            'live': Colors.GREEN,
            'paper': Colors.YELLOW,
            'backtest': Colors.BLUE,
            'stopped': Colors.RED,
        }.get(status, Colors.END)
        
        print(f"{s['id']:<20} {s['name']:<20} {s['version']:<10} "
              f"{status_color}{status:<10}{Colors.END} {s.get('updated_at', '')[:19]}")
    
    print(f"\n共 {len(strategies)} 个策略")


def cmd_strategy(args):
    """查看策略详情"""
    strategy_id = args.strategy_id
    print_header(f"策略详情: {strategy_id}")
    
    result = api_get(f"/strategies/{strategy_id}")
    s = result.get("data", {})
    
    print(f"ID:          {s.get('id')}")
    print(f"名称:        {s.get('name')}")
    print(f"版本:        {s.get('version')}")
    print(f"状态:        {s.get('status')}")
    print(f"描述:        {s.get('description', '-')}")
    print(f"代码路径:    {s.get('code_path', '-')}")
    print(f"创建时间:    {s.get('created_at')}")
    print(f"更新时间:    {s.get('updated_at')}")
    
    # 显示参数
    params = s.get('parameters', {})
    if params:
        print(f"\n参数:")
        for k, v in params.items():
            print(f"  - {k}: {v}")
    
    # 显示最新回测
    bt = s.get('latest_backtest')
    if bt:
        metrics = bt.get('metrics', {})
        print(f"\n最新回测 ({bt.get('id')}):")
        print(f"  区间:      {bt.get('start_date')} ~ {bt.get('end_date')}")
        print(f"  年化收益:  {metrics.get('annual_return', 0)*100:.2f}%")
        print(f"  最大回撤:  {metrics.get('max_drawdown', 0)*100:.2f}%")
        print(f"  夏普比率:  {metrics.get('sharpe_ratio', 0):.2f}")
        print(f"  胜率:      {metrics.get('win_rate', 0)*100:.1f}%")


def cmd_backtests(args):
    """列出回测结果"""
    print_header("回测结果列表")
    
    endpoint = "/backtests"
    if args.strategy:
        endpoint += f"?strategy_id={args.strategy}"
    
    result = api_get(endpoint)
    backtests = result.get("data", [])
    
    if not backtests:
        print_warning("暂无回测结果")
        return
    
    print(f"{'ID':<25} {'策略':<15} {'区间':<25} {'年化':<10} {'回撤':<10} {'夏普':<8}")
    print("-" * 100)
    
    for bt in backtests:
        metrics = bt.get('metrics', {})
        annual = metrics.get('annual_return', 0) * 100
        mdd = metrics.get('max_drawdown', 0) * 100
        sharpe = metrics.get('sharpe_ratio', 0)
        
        annual_color = Colors.GREEN if annual > 0 else Colors.RED
        mdd_color = Colors.GREEN if mdd < 15 else Colors.YELLOW if mdd < 25 else Colors.RED
        
        print(f"{bt['id']:<25} {bt.get('strategy_id', ''):<15} "
              f"{bt.get('start_date', '')[:10]}~{bt.get('end_date', '')[:10]:<14} "
              f"{annual_color}{annual:>8.2f}%{Colors.END} "
              f"{mdd_color}{mdd:>8.2f}%{Colors.END} "
              f"{sharpe:>7.2f}")
    
    print(f"\n共 {len(backtests)} 个回测结果")


def cmd_backtest(args):
    """查看回测详情"""
    backtest_id = args.backtest_id
    print_header(f"回测详情: {backtest_id}")
    
    result = api_get(f"/backtests/{backtest_id}")
    bt = result.get("data", {})
    
    print(f"ID:          {bt.get('id')}")
    print(f"策略ID:      {bt.get('strategy_id')}")
    print(f"策略名称:    {bt.get('strategy_name')}")
    print(f"回测区间:    {bt.get('start_date')} ~ {bt.get('end_date')}")
    print(f"初始资金:    ¥{bt.get('initial_capital', 0):,.0f}")
    print(f"最终资金:    ¥{bt.get('final_capital', 0):,.0f}")
    
    metrics = bt.get('metrics', {})
    print(f"\n绩效指标:")
    print(f"  总收益率:    {metrics.get('total_return', 0)*100:.2f}%")
    print(f"  年化收益:    {metrics.get('annual_return', 0)*100:.2f}%")
    print(f"  最大回撤:    {metrics.get('max_drawdown', 0)*100:.2f}%")
    print(f"  夏普比率:    {metrics.get('sharpe_ratio', 0):.2f}")
    print(f"  索提诺比率:  {metrics.get('sortino_ratio', 0):.2f}")
    print(f"  卡玛比率:    {metrics.get('calmar_ratio', 0):.2f}")
    print(f"  胜率:        {metrics.get('win_rate', 0)*100:.1f}%")
    print(f"  盈亏比:      {metrics.get('profit_loss_ratio', 0):.2f}")
    print(f"  总交易次数:  {metrics.get('total_trades', 0)}")
    print(f"  波动率:      {metrics.get('volatility', 0)*100:.2f}%")
    print(f"  Alpha:       {metrics.get('alpha', 0):.4f}")
    print(f"  Beta:        {metrics.get('beta', 0):.2f}")
    
    # 显示最近交易
    trades = bt.get('trades', [])[:5]
    if trades:
        print(f"\n最近交易 (共 {len(bt.get('trades', []))} 笔):")
        for t in trades:
            action = t.get('action', t.get('side', ''))
            symbol = t.get('stock', t.get('symbol', ''))
            print(f"  {t.get('date', '')[:10]} {action:<4} {symbol} "
                  f"¥{t.get('price', 0):.2f} x {t.get('quantity', t.get('volume', 0))}")


def cmd_trades(args):
    """列出交易记录"""
    print_header("交易记录")
    
    endpoint = "/trades"
    params = []
    if args.strategy:
        params.append(f"strategy_id={args.strategy}")
    if args.limit:
        params.append(f"limit={args.limit}")
    
    if params:
        endpoint += "?" + "&".join(params)
    
    result = api_get(endpoint)
    trades = result.get("data", [])
    
    if not trades:
        print_warning("暂无交易记录")
        return
    
    print(f"{'时间':<20} {'策略':<15} {'代码':<12} {'方向':<6} {'价格':<10} {'数量':<8} {'盈亏':<10}")
    print("-" * 90)
    
    for t in trades:
        side = t.get('side', '')
        side_color = Colors.RED if side == 'BUY' else Colors.GREEN
        pnl = t.get('pnl', 0)
        pnl_color = Colors.GREEN if pnl > 0 else Colors.RED if pnl < 0 else Colors.END
        
        print(f"{t.get('trade_time', '')[:19]:<20} {t.get('strategy_id', ''):<15} "
              f"{t.get('symbol', ''):<12} {side_color}{side:<6}{Colors.END} "
              f"¥{t.get('price', 0):<9.2f} {t.get('volume', 0):<8} "
              f"{pnl_color}¥{pnl:<9.2f}{Colors.END}")
    
    print(f"\n共 {len(trades)} 条记录")


def cmd_deploy(args):
    """部署策略"""
    strategy_id = args.strategy_id
    print_header(f"部署策略: {strategy_id}")
    
    result = api_post("/strategies/deploy", {"strategy_id": strategy_id})
    
    if result.get("success"):
        print_success(result.get("message", "部署成功"))
        if "deployed_path" in result:
            print_info(f"部署路径: {result['deployed_path']}")
    else:
        print_error(result.get("message", "部署失败"))


def cmd_refresh(args):
    """刷新数据"""
    print_header("刷新数据")
    
    result = api_post("/refresh")
    
    if result.get("success"):
        print_success("数据已刷新")
        print_info(f"策略数量: {result.get('strategies_count', 0)}")
        print_info(f"回测数量: {result.get('backtests_count', 0)}")
    else:
        print_error("刷新失败")


def cmd_prompt(args):
    """生成 Prompt"""
    prompt_type = args.type
    print_header(f"生成 Prompt: {prompt_type}")
    
    from core.ptrade_integration import get_ptrade_integration
    integration = get_ptrade_integration()
    
    if prompt_type == "strategy":
        prompt = integration.create_strategy_prompt(
            description="请描述您的策略需求",
            strategy_type="多因子选股策略",
            stock_pool="中证800成分股",
            factors="动量因子、价值因子(PE/PB)、质量因子(ROE)",
            parameters="回看周期20天，单股持仓上限10%，止损8%"
        )
    elif prompt_type == "factor":
        prompt = integration.create_factor_strategy_prompt(
            factors=["动量因子(20日收益率)", "价值因子(PE分位数)", "质量因子(ROE)", "波动率因子"],
            weights={"动量因子": 0.3, "价值因子": 0.25, "质量因子": 0.25, "波动率因子": 0.2},
        )
    elif prompt_type == "optimize":
        prompt = integration.create_optimization_prompt(
            code="# 请粘贴您的策略代码",
            total_return=0.15,
            max_drawdown=0.10,
            sharpe_ratio=1.5,
        )
    else:
        print_error(f"未知的 Prompt 类型: {prompt_type}")
        print_info("可用类型: strategy, factor, optimize")
        return
    
    # 保存并复制
    file_path = integration.save_prompt_to_file(prompt, f"{prompt_type}_prompt.md")
    print_success(f"Prompt 已保存到: {file_path}")
    
    if integration.copy_to_clipboard(prompt):
        print_success("已复制到剪贴板")
    
    print(f"\n{Colors.CYAN}{'='*60}{Colors.END}")
    print(prompt[:500] + "..." if len(prompt) > 500 else prompt)
    print(f"{Colors.CYAN}{'='*60}{Colors.END}")


# ==================== 主程序 ====================

def main():
    parser = argparse.ArgumentParser(
        description="PTrade Bridge CLI - 韬睿量化命令行工具",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s strategies                    列出所有策略
  %(prog)s strategy momentum_strategy    查看策略详情
  %(prog)s backtests --strategy xxx      列出某策略的回测
  %(prog)s backtest bt_xxx               查看回测详情
  %(prog)s trades --limit 50             列出最近50条交易
  %(prog)s deploy momentum_strategy      部署策略到 PTrade
  %(prog)s prompt strategy               生成策略 Prompt
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="命令")
    
    # strategies
    subparsers.add_parser("strategies", help="列出所有策略")
    
    # strategy
    p = subparsers.add_parser("strategy", help="查看策略详情")
    p.add_argument("strategy_id", help="策略 ID")
    
    # backtests
    p = subparsers.add_parser("backtests", help="列出回测结果")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    
    # backtest
    p = subparsers.add_parser("backtest", help="查看回测详情")
    p.add_argument("backtest_id", help="回测 ID")
    
    # trades
    p = subparsers.add_parser("trades", help="列出交易记录")
    p.add_argument("--strategy", "-s", help="筛选策略 ID")
    p.add_argument("--limit", "-l", type=int, default=50, help="限制条数")
    
    # deploy
    p = subparsers.add_parser("deploy", help="部署策略到 PTrade")
    p.add_argument("strategy_id", help="策略 ID")
    
    # refresh
    subparsers.add_parser("refresh", help="刷新数据")
    
    # prompt
    p = subparsers.add_parser("prompt", help="生成 Prompt")
    p.add_argument("type", choices=["strategy", "factor", "optimize"], help="Prompt 类型")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # 执行命令
    commands = {
        "strategies": cmd_strategies,
        "strategy": cmd_strategy,
        "backtests": cmd_backtests,
        "backtest": cmd_backtest,
        "trades": cmd_trades,
        "deploy": cmd_deploy,
        "refresh": cmd_refresh,
        "prompt": cmd_prompt,
    }
    
    cmd_func = commands.get(args.command)
    if cmd_func:
        cmd_func(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()














