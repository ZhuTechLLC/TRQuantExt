#!/usr/bin/env bash
# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac






# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac




# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac

# ============================================================
# éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿå®‰è£…ä¸é…ç½®è„šæœ¬
# ç»Ÿä¸€ç®¡ç†å®‰è£…ã€å¿«æ·æ–¹å¼ã€ç‰ˆæœ¬æ¸…ç†
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# é…ç½®è·¯å¾„
INSTALL_DIR="${HOME}/.local/share/trquant"
LAUNCHER_PATH="${HOME}/.local/bin/jqquant"
DESKTOP_DIR="${HOME}/.local/share/applications"
DESKTOP_FILE="${DESKTOP_DIR}/jqquant.desktop"
ICON_DIR="${HOME}/.local/share/icons/hicolor/256x256/apps"
ICON_SOURCE="${PROJECT_ROOT}/gui/resources/jqquant_icon.svg"
ICON_TARGET="${ICON_DIR}/jqquant.svg"
ARCHIVE_DIR="${HOME}/.local/share/trquant_archive"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘          éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ - ç³»ç»Ÿé…ç½®å·¥å…·                    â•‘"
    echo "â•‘          Taorui Quant Professional Edition               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶
cleanup_old_versions() {
    echo -e "${YELLOW}ğŸ§¹ æ£€æŸ¥å¹¶æ¸…ç†æ—§ç‰ˆæœ¬...${NC}"
    
    # æŸ¥æ‰¾å¯èƒ½çš„å†²çªæ–‡ä»¶
    local conflicts=()
    
    # æ£€æŸ¥å¤šä¸ª.desktopæ–‡ä»¶
    while IFS= read -r f; do
        [[ -f "$f" ]] && conflicts+=("$f")
    done < <(find "${HOME}" -maxdepth 4 -name "*jqquant*.desktop" -o -name "*JQQuant*.desktop" 2>/dev/null | grep -v Trash || true)
    
    if [[ ${#conflicts[@]} -gt 1 ]]; then
        echo -e "${YELLOW}å‘ç°å¤šä¸ªå¿«æ·æ–¹å¼æ–‡ä»¶:${NC}"
        for f in "${conflicts[@]}"; do
            echo "  - $f"
        done
        
        # ä¿ç•™æ ‡å‡†ä½ç½®çš„ï¼Œç§»é™¤å…¶ä»–çš„
        for f in "${conflicts[@]}"; do
            if [[ "$f" != "${DESKTOP_FILE}" ]] && [[ "$f" != "${HOME}/Desktop/jqquant.desktop" ]]; then
                echo -e "  ${RED}ç§»é™¤: $f${NC}"
                rm -f "$f"
            fi
        done
    fi
    
    # æ£€æŸ¥æ—§çš„å®‰è£…ç›®å½•
    if [[ -d "${INSTALL_DIR}" ]]; then
        local install_time
        install_time=$(stat -c %Y "${INSTALL_DIR}" 2>/dev/null || echo "0")
        local project_time
        project_time=$(stat -c %Y "${PROJECT_ROOT}/JQQuant.py" 2>/dev/null || echo "0")
        
        if [[ "${project_time}" -gt "${install_time}" ]]; then
            echo -e "${YELLOW}å®‰è£…ç›®å½•ç‰ˆæœ¬è¾ƒæ—§ï¼Œå°†æ›´æ–°${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ“ æ¸…ç†å®Œæˆ${NC}"
}

# å½’æ¡£æ—§ç‰ˆæœ¬
archive_old_version() {
    if [[ -d "${INSTALL_DIR}" ]]; then
        local timestamp
        timestamp=$(date '+%Y%m%d_%H%M%S')
        local archive_path="${ARCHIVE_DIR}/jqquant_${timestamp}"
        
        echo -e "${BLUE}ğŸ“¦ å½’æ¡£æ—§ç‰ˆæœ¬åˆ°: ${archive_path}${NC}"
        mkdir -p "${ARCHIVE_DIR}"
        mv "${INSTALL_DIR}" "${archive_path}"
        
        # åªä¿ç•™æœ€è¿‘3ä¸ªå½’æ¡£
        local count
        count=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        if [[ ${count} -gt 3 ]]; then
            echo -e "${YELLOW}æ¸…ç†æ—§å½’æ¡£ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...${NC}"
            ls -1t "${ARCHIVE_DIR}" | tail -n +4 | xargs -I {} rm -rf "${ARCHIVE_DIR}/{}"
        fi
    fi
}

# å®‰è£…/æ›´æ–°åº”ç”¨
install_app() {
    echo -e "${BLUE}ğŸ“¥ å®‰è£…éŸ¬ç¿é‡åŒ–ä¸“ä¸šç‰ˆ...${NC}"
    echo ""
    
    cleanup_old_versions
    
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "${YELLOW}æ£€æµ‹åˆ°å·²æœ‰å®‰è£…${NC}"
        read -p "æ˜¯å¦å½’æ¡£æ—§ç‰ˆæœ¬å¹¶å®‰è£…æœ€æ–°ç‰ˆ? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            archive_old_version
        else
            echo -e "${YELLOW}å°†ç›´æ¥è¦†ç›–å®‰è£…${NC}"
            rm -rf "${INSTALL_DIR}"
        fi
    fi
    
    echo ""
    echo "1. åˆ›å»ºç›®å½•..."
    mkdir -p "${INSTALL_DIR}" "${HOME}/.local/bin" "${DESKTOP_DIR}" "${ICON_DIR}"
    
    echo "2. å¤åˆ¶ç¨‹åºæ–‡ä»¶..."
    if command -v rsync &>/dev/null; then
        rsync -a \
            --exclude ".git/" \
            --exclude ".cursor/" \
            --exclude "__pycache__/" \
            --exclude ".mypy_cache/" \
            --exclude ".pytest_cache/" \
            --exclude "venv/" \
            --exclude "jqdata_env/" \
            --exclude "terminals/" \
            --exclude "*.pyc" \
            --exclude "*.pyo" \
            "${PROJECT_ROOT}/" "${INSTALL_DIR}/"
    else
        cp -r "${PROJECT_ROOT}/." "${INSTALL_DIR}/"
        rm -rf "${INSTALL_DIR}/.git" "${INSTALL_DIR}/venv" "${INSTALL_DIR}/__pycache__"
    fi
    
    echo "3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv "${INSTALL_DIR}/venv"
    
    echo "4. å®‰è£…ä¾èµ–..."
    source "${INSTALL_DIR}/venv/bin/activate"
    pip install --upgrade pip -q
    pip install -r "${INSTALL_DIR}/requirements.txt" -q
    deactivate
    
    echo "5. åˆ›å»ºå¯åŠ¨è„šæœ¬..."
    create_launcher
    
    echo "6. åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼..."
    create_desktop_entry
    
    echo "7. å®‰è£…å›¾æ ‡..."
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    echo "8. æ›´æ–°ç³»ç»Ÿç¼“å­˜..."
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    âœ… å®‰è£…å®Œæˆï¼                         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "å¯åŠ¨æ–¹å¼:"
    echo "  1. åœ¨åº”ç”¨èœå•ä¸­æœç´¢ 'éŸ¬ç¿é‡åŒ–'"
    echo "  2. ç»ˆç«¯è¿è¡Œ: jqquant"
    echo "  3. Dockerè¿è¡Œ: ./scripts/docker_manager.sh gui"
    echo ""
}

# åˆ›å»ºå¯åŠ¨å™¨è„šæœ¬
create_launcher() {
    cat > "${LAUNCHER_PATH}" <<'LAUNCHER_EOF'
#!/usr/bin/env bash
set -euo pipefail

# ä¼˜å…ˆä½¿ç”¨å®‰è£…ç›®å½•ï¼Œå…¶æ¬¡ä½¿ç”¨å¼€å‘ç›®å½•
APP_DIR="${JQQUANT_APP_DIR:-${HOME}/.local/share/trquant}"
FALLBACK_DIR="${HOME}/dev/QuantTest/TRQuant"

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    APP_DIR="${FALLBACK_DIR}"
fi

if [[ ! -f "${APP_DIR}/JQQuant.py" ]]; then
    echo "âŒ æ‰¾ä¸åˆ°JQQuantåº”ç”¨ï¼Œè¯·é‡æ–°å®‰è£…"
    exit 1
fi

cd "${APP_DIR}"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [[ -f "venv/bin/activate" ]]; then
    source "venv/bin/activate"
fi

export PYTHONPATH="${APP_DIR}:${PYTHONPATH:-}"
exec python3 JQQuant.py "$@"
LAUNCHER_EOF
    chmod +x "${LAUNCHER_PATH}"
}

# åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
create_desktop_entry() {
    cat > "${DESKTOP_FILE}" <<DESKTOP_EOF
[Desktop Entry]
Version=2.0
Type=Application
Name=éŸ¬ç¿é‡åŒ–
Name[en]=Taorui Quant
Comment=æœºæ„çº§é‡åŒ–æŠ•ç ”å¹³å°
Comment[en]=Institutional Quantitative Research Platform
Exec=${LAUNCHER_PATH}
Icon=${ICON_TARGET}
Terminal=false
Categories=Finance;Office;Development;Science;
StartupNotify=true
StartupWMClass=JQQuant
Keywords=quant;trading;stock;finance;backtest;é‡åŒ–;äº¤æ˜“;
DESKTOP_EOF

    # å¤åˆ¶åˆ°æ¡Œé¢
    if [[ -d "${HOME}/Desktop" ]]; then
        cp "${DESKTOP_FILE}" "${HOME}/Desktop/jqquant.desktop"
        chmod +x "${HOME}/Desktop/jqquant.desktop"
    fi
}

# ä»…æ›´æ–°å¿«æ·æ–¹å¼
update_shortcuts() {
    echo -e "${BLUE}ğŸ”„ æ›´æ–°å¿«æ·æ–¹å¼...${NC}"
    
    cleanup_old_versions
    create_launcher
    create_desktop_entry
    
    # æ›´æ–°å›¾æ ‡
    mkdir -p "${ICON_DIR}"
    cp "${ICON_SOURCE}" "${ICON_TARGET}"
    
    # åˆ·æ–°ç¼“å­˜
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    gtk-update-icon-cache -f "${HOME}/.local/share/icons/hicolor/" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¿«æ·æ–¹å¼å·²æ›´æ–°${NC}"
}

# å¸è½½
uninstall_app() {
    echo -e "${YELLOW}ğŸ—‘ï¸ å¸è½½éŸ¬ç¿é‡åŒ–...${NC}"
    
    read -p "ç¡®å®šè¦å¸è½½å—? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆå¸è½½"
        exit 0
    fi
    
    rm -rf "${INSTALL_DIR}"
    rm -f "${LAUNCHER_PATH}"
    rm -f "${DESKTOP_FILE}"
    rm -f "${HOME}/Desktop/jqquant.desktop"
    rm -f "${ICON_TARGET}"
    
    update-desktop-database "${DESKTOP_DIR}" 2>/dev/null || true
    
    echo -e "${GREEN}âœ“ å¸è½½å®Œæˆ${NC}"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo ""
    
    echo "å®‰è£…ç›®å½•:"
    if [[ -d "${INSTALL_DIR}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${INSTALL_DIR}"
        local version_file="${INSTALL_DIR}/gui/styles/theme.py"
        if [[ -f "${version_file}" ]]; then
            local mod_time
            mod_time=$(stat -c '%y' "${version_file}" | cut -d'.' -f1)
            echo "     æœ€åæ›´æ–°: ${mod_time}"
        fi
    else
        echo -e "  ${RED}âœ—${NC} æœªå®‰è£…"
    fi
    
    echo ""
    echo "å¯åŠ¨å™¨:"
    if [[ -x "${LAUNCHER_PATH}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${LAUNCHER_PATH}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "æ¡Œé¢å¿«æ·æ–¹å¼:"
    if [[ -f "${DESKTOP_FILE}" ]]; then
        echo -e "  ${GREEN}âœ“${NC} ${DESKTOP_FILE}"
    else
        echo -e "  ${RED}âœ—${NC} æœªæ‰¾åˆ°"
    fi
    
    echo ""
    echo "å½’æ¡£ç‰ˆæœ¬:"
    if [[ -d "${ARCHIVE_DIR}" ]]; then
        local archives
        archives=$(ls -1 "${ARCHIVE_DIR}" 2>/dev/null | wc -l)
        echo "  å…± ${archives} ä¸ªå½’æ¡£ç‰ˆæœ¬"
        ls -1t "${ARCHIVE_DIR}" 2>/dev/null | head -3 | while read -r d; do
            echo "    - ${d}"
        done
    else
        echo "  æ— å½’æ¡£"
    fi
}

# å¸®åŠ©
show_help() {
    echo "ç”¨æ³•: $0 <å‘½ä»¤>"
    echo ""
    echo "å‘½ä»¤:"
    echo "  install      å®‰è£…/æ›´æ–°åº”ç”¨ï¼ˆå®Œæ•´å®‰è£…ï¼‰"
    echo "  update       ä»…æ›´æ–°å¿«æ·æ–¹å¼"
    echo "  uninstall    å¸è½½åº”ç”¨"
    echo "  status       æ˜¾ç¤ºå®‰è£…çŠ¶æ€"
    echo "  cleanup      æ¸…ç†æ—§ç‰ˆæœ¬å’Œå†²çªæ–‡ä»¶"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©"
}

# ä¸»å…¥å£
print_banner

case "${1:-help}" in
    install)    install_app ;;
    update)     update_shortcuts ;;
    uninstall)  uninstall_app ;;
    status)     show_status ;;
    cleanup)    cleanup_old_versions ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
        show_help
        exit 1
        ;;
esac














