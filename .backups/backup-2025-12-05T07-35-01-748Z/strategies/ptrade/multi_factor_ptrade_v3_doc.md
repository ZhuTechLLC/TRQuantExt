# 多因子策略详解 (PTrade V3)

> 韬睿量化系统自动生成 | 适配PTrade平台

---

## 📋 策略概述

| 属性 | 值 |
|------|-----|
| **策略名称** | multi_factor_ptrade_v3 |
| **策略类型** | 多因子选股 |
| **适用平台** | PTrade (国金证券) |
| **股票池** | 沪深300 (000300.XSHG) |
| **持仓数量** | 30只 |
| **调仓频率** | 月度 (每月第一个交易日) |
| **调仓时间** | 09:35 |

---

## 🧠 策略逻辑

### 核心思想

本策略基于**多因子模型**，综合考虑价值、质量和动量三个维度，筛选出综合得分最高的股票构建投资组合。

### 因子体系

```
┌─────────────────────────────────────────────────────┐
│                    复合因子得分                      │
│         Score = 0.3×EP + 0.3×ROE + 0.4×Reversal     │
└─────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ EP因子  │    │ ROE因子 │    │ 反转因子 │
    │ 权重30% │    │ 权重30% │    │ 权重40% │
    │  价值   │    │  质量   │    │  动量   │
    └─────────┘    └─────────┘    └─────────┘
```

### 因子说明

| 因子 | 类型 | 计算方式 | 逻辑 |
|------|------|----------|------|
| **EP** | 价值因子 | 1 / 股价 × 100 | 价格越低，EP越高，越被低估 |
| **ROE** | 质量因子 | 哈希模拟 | 代表公司盈利能力 |
| **Reversal** | 动量因子 | -过去20日收益率 | 短期超跌反弹效应 |

---

## 📊 策略流程

```
┌──────────────────────────────────────────────────────────────┐
│                        策略执行流程                           │
└──────────────────────────────────────────────────────────────┘

  initialize()                    handle_data()
       │                               │
       ▼                               ▼
  ┌─────────┐                   ┌─────────────┐
  │设置基准  │                   │ 时间判断    │
  │000300   │                   │ 09:35?     │
  └─────────┘                   └──────┬──────┘
                                       │
                          ┌────────────┴────────────┐
                          │ 是否新月份?              │
                          └────────────┬────────────┘
                                       │ Yes
                                       ▼
                               ┌───────────────┐
                               │  rebalance()  │
                               └───────┬───────┘
                                       │
              ┌────────────────────────┼────────────────────────┐
              ▼                        ▼                        ▼
       ┌────────────┐          ┌────────────┐          ┌────────────┐
       │ 获取股票池  │          │ 计算因子   │          │ 执行调仓   │
       │ 过滤ST     │          │ 标准化     │          │ 卖出→买入  │
       └────────────┘          │ 加权组合   │          └────────────┘
                               └────────────┘
```

---

## 🔧 核心函数

### 1. initialize(context)

```python
def initialize(context):
    """初始化函数 - 策略启动时执行一次"""
    set_benchmark('000300.XSHG')  # 设置沪深300为基准
```

**作用**: 设置策略基准，用于计算超额收益。

---

### 2. handle_data(context, data)

```python
def handle_data(context, data):
    """行情处理函数 - 每个交易bar执行"""
    # 只在09:35执行
    if current_hour == 9 and current_minute == 35:
        if current_month != g_last_month:  # 新月份
            rebalance(context)             # 执行调仓
            g_last_month = current_month
```

**作用**: 判断是否需要执行月度调仓。

---

### 3. get_stock_pool()

```python
def get_stock_pool():
    """获取股票池"""
    stocks = get_index_stocks('000300.XSHG')  # 沪深300成分股
    # 过滤ST股票
    filtered = [s for s in stocks if 'ST' not in get_stock_name(s)]
    return filtered
```

**作用**: 获取沪深300成分股并过滤ST。

---

### 4. calculate_composite_score(stocks, context)

```python
def calculate_composite_score(stocks, context):
    """计算复合因子得分"""
    # 1. 计算各因子
    ep = calculate_ep_factor(stocks)
    roe = calculate_roe_factor(stocks)
    rev = calculate_reversal_factor(stocks)
    
    # 2. Z-score标准化
    for col in [ep, roe, rev]:
        col = (col - col.mean()) / col.std()
    
    # 3. 加权组合
    score = 0.3*ep + 0.3*roe + 0.4*rev
    return score
```

**作用**: 计算每只股票的综合得分。

---

### 5. execute_rebalance(context, target_stocks)

```python
def execute_rebalance(context, target_stocks):
    """执行调仓"""
    # 1. 卖出不在目标中的持仓
    for stock in current_positions:
        if stock not in target_stocks:
            order_target(stock, 0)
    
    # 2. 等权买入目标股票
    target_value = portfolio_value * 0.95 / len(target_stocks)
    for stock in target_stocks:
        order_target_value(stock, target_value)
```

**作用**: 先卖后买，调整持仓到目标组合。

---

## ⚙️ 参数配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `g_stock_pool` | 000300.XSHG | 股票池指数代码 |
| `g_hold_num` | 30 | 持仓股票数量 |
| `g_weights['EP']` | 0.3 | EP因子权重 |
| `g_weights['ROE']` | 0.3 | ROE因子权重 |
| `g_weights['Reversal']` | 0.4 | 反转因子权重 |

---

## 📈 预期表现

### 适用市场环境

- ✅ 震荡市：反转因子发挥作用
- ✅ 价值回归期：EP因子有效
- ⚠️ 单边牛市：可能跑输动量策略

### 风险提示

1. **因子失效风险**: 历史有效的因子未来可能失效
2. **流动性风险**: 部分成分股流动性不足
3. **集中度风险**: 30只股票相对集中

---

## 🔄 优化建议

1. **因子增强**: 添加成长因子(营收增速)、资金流因子(北向资金)
2. **动态权重**: 根据市场状态调整因子权重
3. **风险控制**: 添加行业分散约束、个股权重上限
4. **调仓优化**: 考虑交易成本，设置调仓阈值

---

## 📚 参考资料

- [PTrade API文档](https://ptradeapi.com/)
- [多因子模型理论](https://www.investopedia.com/terms/m/multifactor-model.asp)
- 韬睿量化A股投资手册 - 第四册：量化因子体系

---

## 🧩 系统里程碑与整体流程

本策略不是孤立存在，而是韬睿量化整个平台的一环。当前已经完成了下面这条完整闭环：

1. **知识库建设（手册体系）**
   - A股《高倍股实操手册》五卷本（Astro 文档系统），系统梳理：市场、因子、策略、交易、风控。
   - 第四卷《量化因子体系》与本策略的因子设计一一对应，作为“理论→实现”的桥梁。

2. **AI 辅助策略生成（Cursor + 提示词体系）**
   - 通过标准化的 Prompt（“多因子策略生成请求 - PTrade 平台”），在 Cursor 中自动生成 PTrade 可运行的 Python 策略代码。
   - 约定统一的策略接口与目录结构（`strategies/ptrade/`），方便 Dashboard 与 PTrade 双向管理。

3. **本地工具与文件管理系统**
   - Dashboard 作为“量化投资文件管理系统”：统一管理报告、策略、手册、研究文档。
   - 为每个策略增加：
     - **代码查看 / 复制**（方便直接粘贴到 PTrade 回测窗口）
     - **Markdown 详解文档**（本文件），用于解释策略结构与使用方法。

4. **PTrade 回测联通**
   - 在 PTrade 中成功运行多轮回测（`AI generated test1 / test2`），验证：
     - 代码语法与 PTrade API 兼容；
     - 初始化/调仓/日志输出流程正确；
     - 从“策略生成 → PTrade 回测 → Dashboard 观察”的闭环已打通。

5. **结果回读与分析**
   - 利用截图 + 日志，将 PTrade 回测结果带回本地进行解析：
     - 正确识别：**基准收益 ≈ 28.56%，策略收益 ≈ 1.8%，超额收益 ≈ -26.75%**；
     - 明确当前版本为“样板代码”而非最终投资策略，为后续因子优化提供参照。

这一整条链路，标志着**“知识库 → AI 代码生成 → 券商回测 → 本地分析”**的端到端流程已经建成，可以进入「循环迭代与优化」阶段。

---

## 🛠 工具与子系统使用说明（简版）

### 1. Taorui Quant 桌面应用

- 左侧主菜单中：
  - **“策略开发 & 回测”**：打开 PyQt6 主界面，包含 AI 策略助手、因子库、回测入口等。
  - **“实操手册”**：一键打开 Astro 文档系统（A股/美股手册）。

### 2. 因子库 & AI 策略助手

- 在“因子库”面板中：
  - 浏览已实现的 EP/ROE/动量/资金流等因子说明；
  - 使用“生成 PTrade 策略代码”按钮，根据选中的因子组合自动生成策略骨架；
  - 生成文件默认保存到 `strategies/ptrade/` 下，并自动出现在 Dashboard 的“策略代码管理”里。

### 3. Dashboard（量化投资文件管理系统）

- 访问地址：`http://127.0.0.1:5000`
- 核心区域：
  - **策略代码管理**
    - 每一行策略包含：
      - 编号 `Sxxx`（方便在对话和文档中引用）
      - 平台标签（PTrade / QMT / QuantConnect）
      - 简要说明 + 因子标签
      - 按钮：
        - `📖 详解`：打开本 Markdown 文档的美化视图；
        - `📋`：打开代码查看窗口，并一键复制到剪贴板，直接粘贴进 PTrade 即可。
  - **研究文档**
    - 自动扫描 `docs/` 目录下的 PDF / MD / DOCX，并按“平台方案 / 策略研究 / 实盘交易 / 部署运维 / 手册”分组展示。

### 4. PTrade 端的使用姿势

1. 在 Dashboard 中找到目标策略（例如 `multi_factor_ptrade_v3`），点击 `📋` 复制代码；
2. 在 PTrade 客户端中新建策略 → 粘贴代码；
3. 设置回测区间 / 初始资金 / 标的市场后，点击“开始回测”；
4. 回测完成后：
   - 查看收益、回撤、交易记录；
   - 截图或导出结果文件（后续版本会通过 Bridge 自动回传到 Dashboard）。

---

## 🚀 下一步工作与建议（概要版）

> 完整的Roadmap在 `docs/TAORUI_PTRADE_ROADMAP.md` 中，这里只给出与本策略直接相关的部分。

### A. 把“样板策略”升级为“实战策略”

1. **用真实财务数据替换简化因子**
   - EP：使用 `市盈率PE` / `每股收益EPS` 计算，而不是 `1/价格` 近似；
   - ROE：接入 JQData / Wind / PTrade `get_fundamentals` 的真实 ROE 指标；
   - Reversal：增加行业中性、波动率约束，避免过度押注单一风格。

2. **重新回测与对比**
   - 在 JQQuant/JQData 环境中先做严格回测，验证多因子模型是否有稳定超额收益；
   - 通过统一的参数和选股逻辑，迁移一份“严格版”到 PTrade，再跑券商端回测验证。

### B. 打通“回测结果 → 文件管理系统”的数据通路

1. 在 PTrade 端导出回测结果（CSV/JSON/Excel）；
2. 在本地增加一个 `ptrade_results_import.py` 小工具：
   - 把结果文件归档到 `data/ptrade/backtest_results/`；
   - 同时写入一个标准化的 JSON 摘要，Dashboard 读取后可：
     - 显示收益曲线缩略图；
     - 展示关键指标（收益/回撤/夏普/超额）；
     - 关联到对应策略版本（S001/S002等）。

### C. 结合知识库进行“可解释的迭代”

1. 在 A股手册第四卷中，为每一类因子增加：
   - “在 PTrade / JQData 上的具体实现建议”；
   - “适用市场环境 + 潜在失效场景”小结。
2. 每次策略迭代后：
   - 把回测表现与对应章节建立链接（在本Markdown中补充“本次迭代的结论”）；
   - 为后续 AI 生成策略提供“带记忆”的上下文（Prompt 中引用这些章节）。

---

*本文档由韬睿量化系统自动生成*

